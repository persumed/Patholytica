<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Article</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #0f0f0f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --card-bg: #1f1f1f;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --accent-hover: #2d8ed6;
  --success: #2ecc71;
  --error: #e74c3c;
}
body.light-theme {
  --bg-color: #ffffff;
  --text-primary: #0f0f0f;
  --text-secondary: #606060;
  --card-bg: #f9f9f9;
  --hover-bg: #f0f0f0;
  --border-color: #e5e5e5;
  --accent: #065fd4;
  --accent-hover: #0448a3;
  --success: #27ae60;
  --error: #c0392b;
}
* { box-sizing: border-box; }
html, body { 
  margin: 0; 
  padding: 0; 
  min-height: 100%; 
  font-family: "Roboto", Arial, sans-serif;
  overflow-x: hidden;
  max-width: 100vw;
}
body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}
.header-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
  width: 100%;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  max-width: 100%;
  margin: 0 auto;
}
.logo-img {
  height: 28px;
  width: auto;
  transition: filter 0.2s ease;
  cursor: pointer;
}
body.light-theme .logo-img {
  filter: invert(1);
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: background 0.2s ease;
}
.icon-btn:hover {
  background: var(--hover-bg);
}
.action-btn {
  padding: 8px 20px;
  border-radius: 20px;
  background: var(--card-bg);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}
.action-btn:hover {
  background: var(--hover-bg);
  transform: translateY(-1px);
}
.action-btn.liked {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}
.article-container {
  max-width: 900px;
  width: 100%;
  margin: 0 auto;
  padding: 80px 24px 120px;
  padding-top: calc(70px + env(safe-area-inset-top));
}
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  gap: 16px;
}
.spinner {
  width: 48px;
  height: 48px;
  border: 4px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.error-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  gap: 16px;
  text-align: center;
}
.error-icon {
  font-size: 64px;
  color: var(--error);
}
.error-text {
  font-size: 18px;
  color: var(--text-secondary);
}
.article-meta {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border-color);
  flex-wrap: wrap;
}
.author-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}
.author-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  color: white;
}
.author-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.author-name {
  font-weight: 500;
  font-size: 15px;
}
.article-date {
  font-size: 13px;
  color: var(--text-secondary);
}
.article-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 14px;
  color: var(--text-secondary);
}
.stat-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.article-title {
  font-family: 'Times New Roman', Times, serif;
  font-size: 42px;
  font-weight: bold;
  margin: 0 0 32px 0;
  line-height: 1.2;
  color: var(--text-primary);
}
.article-content {
  font-family: 'Times New Roman', Times, serif;
  font-size: 21px;
  line-height: 1.8;
  color: var(--text-primary);
}
.content-paragraph {
  margin: 0 0 24px 0;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.media-embed {
  margin: 32px 0;
  padding: 24px 0;
  border-top: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
  max-width: 100%;
  overflow: hidden;
}
.media-embed img {
  width: 100%;
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  display: block;
}
.media-caption {
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 8px;
  font-style: italic;
  text-align: center;
}
.custom-audio-player {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  max-width: 100%;
}
.play-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
.play-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.05);
}
.audio-info {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}
.audio-title {
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 8px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.waveform-container {
  position: relative;
  height: 40px;
  background: var(--hover-bg);
  border-radius: 4px;
  margin-bottom: 8px;
  cursor: pointer;
  overflow: hidden;
}
.waveform-progress {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: var(--accent);
  opacity: 0.3;
  transition: width 0.1s linear;
}
.waveform-bars {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: space-around;
  padding: 0 4px;
}
.waveform-bar {
  width: 2px;
  background: var(--text-secondary);
  border-radius: 2px;
  opacity: 0.6;
}
.audio-time {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text-secondary);
}
.article-actions {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 24px;
  padding: 8px 16px;
  display: flex;
  gap: 8px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  z-index: 20;
}
.notification {
  position: fixed;
  top: calc(70px + env(safe-area-inset-top));
  right: 24px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px 20px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
  z-index: 1000;
  display: none;
  align-items: center;
  gap: 12px;
  min-width: 300px;
}
.notification.show {
  display: flex;
  animation: slideIn 0.3s ease;
}
.notification.success {
  border-left: 4px solid var(--success);
}
.notification.error {
  border-left: 4px solid var(--error);
}
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}
@media (max-width: 768px) {
  .article-container {
    padding: 90px 16px 100px;
  }
  .article-title {
    font-size: 32px;
  }
  .article-content {
    font-size: 19px;
  }
  .notification {
    right: 16px;
    left: 16px;
    min-width: auto;
  }
  .article-meta {
    flex-direction: column;
    align-items: flex-start;
  }
}
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo" onclick="window.location.href='index.html'">
    <div class="header-actions">
      <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-circle-half-stroke"></i>
      </button>
      <button class="icon-btn" onclick="shareArticle()" title="Share">
        <i class="fas fa-share"></i>
      </button>
    </div>
  </div>
</div>

<div class="article-container" id="articleContainer">
  <div class="loading-container" id="loadingContainer">
    <div class="spinner"></div>
    <div style="color: var(--text-secondary);">Loading article...</div>
  </div>
  
  <div id="errorContainer" class="error-container" style="display: none;">
    <i class="fas fa-exclamation-triangle error-icon"></i>
    <div class="error-text">Article not found</div>
    <button class="action-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-home"></i>
      Go to Home
    </button>
  </div>
  
  <div id="articleContent" style="display: none;">
    <div class="article-meta">
      <div class="author-info">
        <div class="author-avatar" id="authorAvatar">A</div>
        <div class="author-details">
          <div class="author-name" id="authorName">Loading...</div>
          <div class="article-date" id="articleDate">Loading...</div>
        </div>
      </div>
      <div class="article-stats">
        <div class="stat-item">
          <i class="fas fa-eye"></i>
          <span id="viewCount">0</span>
        </div>
        <div class="stat-item">
          <i class="fas fa-heart"></i>
          <span id="likeCount">0</span>
        </div>
      </div>
    </div>
    
    <h1 class="article-title" id="articleTitle"></h1>
    <div class="article-content" id="articleBody"></div>
  </div>
</div>

<div class="article-actions" id="articleActions" style="display: none;">
  <button class="action-btn" id="likeBtn" onclick="toggleLike()">
    <i class="fas fa-heart"></i>
    <span id="likeBtnText">Like</span>
  </button>
  <button class="action-btn" onclick="shareArticle()">
    <i class="fas fa-share"></i>
    Share
  </button>
</div>

<div class="notification" id="notification">
  <i class="fas fa-check-circle" style="font-size: 20px;"></i>
  <span id="notificationText"></span>
</div>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Initialize Supabase
const supabase = window.supabase.createClient(
  "https://vduqewqyvszfquntmark.supabase.co",
  "sb_publishable_YseP73aoHam8YT6B0b9EQQ_iAUEWARI"
);

let currentUser = null;
let currentArticle = null;
let userHasLiked = false;

// Check authentication
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    console.log("User authenticated:", user.uid);
    checkIfUserLiked();
  } else {
    currentUser = null;
  }
});

// Get article ID from URL
function getArticleId() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('id');
}

// Load article
async function loadArticle() {
  const articleId = getArticleId();
  
  if (!articleId) {
    showError();
    return;
  }

  try {
    // Fetch article
    const { data: article, error: articleError } = await supabase
      .from('articles')
      .select('*')
      .eq('id', articleId)
      .single();

    if (articleError) throw articleError;
    if (!article) {
      showError();
      return;
    }

    currentArticle = article;

    // Increment view count
    await supabase
      .from('articles')
      .update({ views: (article.views || 0) + 1 })
      .eq('id', articleId);

    // Fetch author info
    const { data: author } = await supabase
      .from('users')
      .select('username, full_name')
      .eq('firebase_uid', article.firebase_user_id)
      .single();

    // Fetch media
    const { data: media } = await supabase
      .from('media')
      .select('*')
      .eq('article_id', articleId)
      .order('display_order', { ascending: true });

    // Display article
    displayArticle(article, author, media);

  } catch (error) {
    console.error('Error loading article:', error);
    showError();
  }
}

function displayArticle(article, author, media) {
  // Hide loading, show content
  document.getElementById('loadingContainer').style.display = 'none';
  document.getElementById('articleContent').style.display = 'block';
  document.getElementById('articleActions').style.display = 'flex';

  // Set title
  document.getElementById('articleTitle').textContent = article.title;
  document.title = `${article.title} — Patholytica`;

  // Set author info
  const authorName = author?.full_name || author?.username || 'Anonymous';
  document.getElementById('authorName').textContent = authorName;
  document.getElementById('authorAvatar').textContent = authorName.charAt(0).toUpperCase();

  // Set date
  const date = new Date(article.created_at);
  document.getElementById('articleDate').textContent = formatDate(date);

  // Set stats
  document.getElementById('viewCount').textContent = (article.views || 0) + 1;
  document.getElementById('likeCount').textContent = article.likes || 0;

  // Display content
  const contentContainer = document.getElementById('articleBody');
  contentContainer.innerHTML = '';

  // Split content into paragraphs
  const paragraphs = article.content.split('\n\n');
  
  paragraphs.forEach((paragraph, index) => {
    if (paragraph.trim()) {
      const p = document.createElement('div');
      p.className = 'content-paragraph';
      p.textContent = paragraph.trim();
      contentContainer.appendChild(p);

      // Insert media at appropriate positions
      if (media && media.length > 0) {
        const relatedMedia = media.filter(m => m.display_order === index);
        relatedMedia.forEach(m => {
          contentContainer.appendChild(createMediaElement(m));
        });
      }
    }
  });

  // Append any remaining media
  if (media) {
    media.filter(m => m.display_order >= paragraphs.length).forEach(m => {
      contentContainer.appendChild(createMediaElement(m));
    });
  }
}

function createMediaElement(mediaItem) {
  const mediaDiv = document.createElement('div');
  mediaDiv.className = 'media-embed';

  if (mediaItem.type === 'image') {
    mediaDiv.innerHTML = `
      <img src="${mediaItem.url}" alt="${mediaItem.caption || 'Article image'}">
      ${mediaItem.caption ? `<div class="media-caption">${mediaItem.caption}</div>` : ''}
    `;
  } else if (mediaItem.type === 'audio') {
    const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
    mediaDiv.innerHTML = `
      <div class="custom-audio-player">
        <button class="play-btn" onclick="toggleAudio(this, '${audioId}')">
          <i class="fas fa-play"></i>
        </button>
        <div class="audio-info">
          <div class="audio-title">${mediaItem.caption || 'Audio'}</div>
          <div class="waveform-container" onclick="seekAudio(event, this, '${audioId}')">
            <div class="waveform-progress"></div>
            <div class="waveform-bars">
              ${Array(20).fill(0).map(() => `<div class="waveform-bar" style="height: ${Math.random() * 60 + 20}%"></div>`).join('')}
            </div>
          </div>
          <div class="audio-time">
            <span class="current-time">0:00</span>
            <span class="duration">0:00</span>
          </div>
        </div>
        <audio id="${audioId}" src="${mediaItem.url}" style="display: none;"></audio>
      </div>
      ${mediaItem.caption ? `<div class="media-caption">${mediaItem.caption}</div>` : ''}
    `;

    // Setup audio metadata loading
    setTimeout(() => {
      const audio = document.getElementById(audioId);
      if (audio) {
        audio.addEventListener('loadedmetadata', function() {
          const duration = Math.floor(audio.duration);
          const mins = Math.floor(duration / 60);
          const secs = duration % 60;
          const durationSpan = audio.closest('.custom-audio-player').querySelector('.duration');
          if (durationSpan) {
            durationSpan.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }
        });
      }
    }, 100);
  }

  return mediaDiv;
}

function formatDate(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
  
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function showError() {
  document.getElementById('loadingContainer').style.display = 'none';
  document.getElementById('errorContainer').style.display = 'flex';
}

// Check if user has liked the article
async function checkIfUserLiked() {
  if (!currentUser || !currentArticle) return;

  const { data } = await supabase
    .from('article_likes')
    .select('*')
    .eq('article_id', currentArticle.id)
    .eq('firebase_user_id', currentUser.uid)
    .single();

  if (data) {
    userHasLiked = true;
    const likeBtn = document.getElementById('likeBtn');
    likeBtn.classList.add('liked');
    document.getElementById('likeBtnText').textContent = 'Liked';
  }
}

// Toggle like
window.toggleLike = async function() {
  if (!currentUser) {
    showNotification('Please log in to like articles', 'error');
    return;
  }

  if (!currentArticle) return;

  const likeBtn = document.getElementById('likeBtn');
  const likeCount = document.getElementById('likeCount');

  try {
    if (userHasLiked) {
      // Unlike
      await supabase
        .from('article_likes')
        .delete()
        .eq('article_id', currentArticle.id)
        .eq('firebase_user_id', currentUser.uid);

      await supabase
        .from('articles')
        .update({ likes: Math.max(0, (currentArticle.likes || 0) - 1) })
        .eq('id', currentArticle.id);

      userHasLiked = false;
      likeBtn.classList.remove('liked');
      document.getElementById('likeBtnText').textContent = 'Like';
      likeCount.textContent = Math.max(0, parseInt(likeCount.textContent) - 1);
      currentArticle.likes = Math.max(0, (currentArticle.likes || 0) - 1);

    } else {
      // Like
      await supabase
        .from('article_likes')
        .insert([{
          article_id: currentArticle.id,
          firebase_user_id: currentUser.uid
        }]);

      await supabase
        .from('articles')
        .update({ likes: (currentArticle.likes || 0) + 1 })
        .eq('id', currentArticle.id);

      userHasLiked = true;
      likeBtn.classList.add('liked');
      document.getElementById('likeBtnText').textContent = 'Liked';
      likeCount.textContent = parseInt(likeCount.textContent) + 1;
      currentArticle.likes = (currentArticle.likes || 0) + 1;
    }
  } catch (error) {
    console.error('Error toggling like:', error);
    showNotification('Error updating like', 'error');
  }
};

// Share article
window.shareArticle = function() {
  const url = window.location.href;
  const title = currentArticle ? currentArticle.title : 'Check out this article';

  if (navigator.share) {
    navigator.share({
      title: title,
      url: url
    }).catch(err => console.log('Error sharing:', err));
  } else {
    navigator.clipboard.writeText(url);
    showNotification('Link copied to clipboard!', 'success');
  }
};

function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  const icon = notification.querySelector('i');
  
  notificationText.textContent = message;
  notification.className = `notification ${type} show`;
  
  if (type === 'success') {
    icon.className = 'fas fa-check-circle';
  } else {
    icon.className = 'fas fa-exclamation-circle';
  }
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 4000);
}

window.showNotification = showNotification;

// Load article on page load
loadArticle();
</script>

<script>
function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}

if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light-theme");
}

window.toggleAudio = function(btn, audioId) {
  const player = btn.closest('.custom-audio-player');
  const audio = document.getElementById(audioId);
  const icon = btn.querySelector('i');
  
  if (audio.paused) {
    audio.play();
    icon.className = 'fas fa-pause';
    
    audio.ontimeupdate = function() {
      const progress = (audio.currentTime / audio.duration) * 100;
      player.querySelector('.waveform-progress').style.width = progress + '%';
      const currentMins = Math.floor(audio.currentTime / 60);
      const currentSecs = Math.floor(audio.currentTime % 60);
      player.querySelector('.current-time').textContent = `${currentMins}:${currentSecs.toString().padStart(2, '0')}`;
    };
    
    audio.onended = function() {
      icon.className = 'fas fa-play';
      player.querySelector('.waveform-progress').style.width = '0%';
      player.querySelector('.current-time').textContent = '0:00';
    };
  } else {
    audio.pause();
    icon.className = 'fas fa-play';
  }
};

window.seekAudio = function(event, container, audioId) {
  const audio = document.getElementById(audioId);
  const rect = container.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const percentage = x / rect.width;
  audio.currentTime = percentage * audio.duration;
};
</script>

</body>
</html>
