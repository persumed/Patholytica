<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Setup Your Profile — Patholytica</title>
<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --card-bg: rgba(24,24,24,0.7);
  --card-border: rgba(255,255,255,0.07);
  --accent: #b0003a;
  --accent-hover: #88002a;
}
body.light-theme {
  --bg-color: #f5f5f5;
  --text-color: #111;
  --card-bg: rgba(255,255,255,0.65);
  --card-border: rgba(0,0,0,0.1);
  --accent: #b0003a;
  --accent-hover: #88002a;
}
* { box-sizing: border-box; }
html, body { margin:0; padding:0; height:100%; font-family: "Inter", Arial, sans-serif; }
body {
  background: var(--bg-color);
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  transition: background 0.35s ease;
}
.header-wrapper {
  position: sticky;
  top: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--card-border);
  z-index: 40;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
}
.logo-img { height: 32px; width: auto; transition: filter 0.25s ease; cursor: pointer; }
body.light-theme .logo-img { filter: invert(1); }
.theme-toggle {
  padding: 6px 14px;
  font-size: 12.5px;
  background: transparent;
  border-radius: 6px;
  border: 1px solid var(--card-border);
  color: var(--text-color);
  cursor: pointer;
  transition: 0.25s ease;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }
.setup-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: calc(40px + env(safe-area-inset-top))
           calc(20px + env(safe-area-inset-left))
           calc(40px + env(safe-area-inset-bottom))
           calc(20px + env(safe-area-inset-right));
}
.setup-card {
  width: 100%;
  max-width: 430px;
  padding: 55px 42px;
  background: var(--card-bg);
  backdrop-filter: blur(22px);
  border-radius: 16px;
  border: 1px solid var(--card-border);
  box-shadow: 0 8px 28px rgba(0,0,0,0.45);
  text-align: center;
  animation: fadeUp 0.5s ease both;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.setup-card:hover { transform: translateY(-4px); box-shadow: 0 12px 35px rgba(0,0,0,0.55); }
.setup-card h1 { font-size: 32px; margin-bottom: 12px; }
.setup-card p { font-size: 15px; margin-bottom: 20px; color: #999; line-height: 1.55; }
#profilePicPreview {
  width:120px;
  height:120px;
  border-radius:50%;
  object-fit:cover;
  margin:10px auto 20px;
  display:block;
  border:2px solid var(--card-border);
  transition: transform 0.25s ease;
}
#profilePicPreview:hover { transform: scale(1.05); }
.upload-label {
  display:inline-block;
  margin:10px 0 20px;
  padding:8px 16px;
  background:var(--accent);
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  transition:0.25s;
  font-size: 14px;
}
.upload-label:hover { background:var(--accent-hover); transform: translateY(-2px); }
input[type="file"] { display:none; }
.input-field {
  width:100%;
  padding:14px;
  margin-bottom:14px;
  border-radius:8px;
  border:1px solid var(--card-border);
  background:rgba(0,0,0,0.25);
  color:var(--text-color);
  font-size:15px;
  transition:0.25s ease;
}
body.light-theme .input-field { background:rgba(255,255,255,0.7); }
.input-field:focus { border-color:var(--accent); outline:none; box-shadow:0 0 8px rgba(176,0,58,0.35); }
.input-field:disabled { 
  opacity:0.7; 
  cursor:not-allowed;
  background:rgba(100,100,100,0.2);
}
body.light-theme .input-field:disabled { 
  background:rgba(200,200,200,0.4); 
}
textarea { resize:none; font-family:inherit; }
.setup-btn {
  display: inline-block;
  padding: 16px 42px;
  font-size: 16px;
  font-weight: 600;
  background: var(--accent);
  color: #fff;
  border-radius: 10px;
  text-decoration: none;
  transition: 0.25s ease;
  box-shadow: 0 6px 16px rgba(176,0,58,0.35);
  cursor: pointer;
  border: none;
  width: 100%;
  margin-top: 12px;
}
.setup-btn:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 10px 22px rgba(176,0,58,0.45); }
.setup-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}
.skip-link {
  display: block;
  margin-top: 12px;
  color: #888;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
}
.skip-link:hover { color: var(--accent); text-decoration: underline; }
footer { text-align: center; padding: 16px; font-size: 11px; border-top: 1px solid var(--card-border); color: #888; }
footer a { color: #888; margin: 0 3px; text-decoration: none; transition: color 0.25s ease; }
footer a:hover { color: var(--accent); }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@media (max-width: 640px) { .setup-card { padding: 45px 30px; } .setup-card h1 { font-size: 27px; } }
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <a href="https://patholytica.com"><img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo"></a>
    <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
  </div>
</div>

<div class="setup-container">
  <div class="setup-card">
    <h1>Complete Your Profile</h1>
    <p>Let's personalize your learning experience</p>

<img id="profilePicPreview" src="https://via.placeholder.com/120" alt="Profile Preview">

<form id="profileForm">
  <label class="upload-label" for="profilePicture">Upload Profile Picture</label>
  <input type="file" id="profilePicture" accept="image/*">
  
  <input type="text" id="fullName" class="input-field" placeholder="Full Name" required>
  <input type="email" id="email" class="input-field" placeholder="Email" readonly disabled>
  <input type="text" id="username" class="input-field" placeholder="Username" required>
  <textarea id="bio" class="input-field" placeholder="Short Bio (optional)" rows="3"></textarea>
  
  <button type="submit" class="setup-btn" id="saveBtn">Save Profile</button>
  <a href="#" class="skip-link" id="skipBtn">Skip for Now</a>
</form>

  </div>
</div>

<footer>
  © 2025 Patholytica by MedicineBank. All rights reserved.
  <br>
  <a href="#">Privacy Policy</a> | <a href="#">Terms</a> | <a href="#">Contact</a>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, updateDoc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// THEME
function toggleTheme(){
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}
if (localStorage.getItem("theme") === "light") { document.body.classList.add("light-theme"); }
window.toggleTheme = toggleTheme;

// DOM Elements
const fullNameInput = document.getElementById('fullName');
const emailInput = document.getElementById('email');
const usernameInput = document.getElementById('username');
const bioInput = document.getElementById('bio');
const profilePicInput = document.getElementById('profilePicture');
const profilePicPreview = document.getElementById('profilePicPreview');
const profileForm = document.getElementById('profileForm');
const saveBtn = document.getElementById('saveBtn');
const skipBtn = document.getElementById('skipBtn');

// Preview selected image
profilePicInput.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(file){
    if(file.size > 5 * 1024 * 1024) {
      alert('Image size must be less than 5MB');
      profilePicInput.value = '';
      return;
    }
    profilePicPreview.src = URL.createObjectURL(file);
  }
});

// Skip button
skipBtn.addEventListener('click', (e) => {
  e.preventDefault();
  if(confirm('Skip profile setup? You can complete it later from settings.')) {
    window.location.href = "main.html";
  }
});

// Check authentication and load user data
onAuthStateChanged(auth, async user => {
  if(!user){
    alert("You must be logged in to setup a profile.");
    window.location.href = "index.html";
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const docSnap = await getDoc(userRef);

  if(docSnap.exists()){
    const data = docSnap.data();
    
    // Check if profile is already completed
    if(data.profileCompleted) {
      if(confirm("You already have a profile set up. Would you like to proceed to the main page?")) {
        window.location.href = "main.html";
        return;
      }
    }
    
    // Pre-fill existing data
    fullNameInput.value = data.fullName || user.displayName || "";
    emailInput.value = data.email || user.email || "";
    usernameInput.value = data.username || "";
    bioInput.value = data.bio || "";
    if(data.profilePicture) profilePicPreview.src = data.profilePicture;
  } else {
    // New user - pre-fill from auth
    emailInput.value = user.email || "";
    if(user.displayName) fullNameInput.value = user.displayName;
    if(user.photoURL) profilePicPreview.src = user.photoURL;
  }
});

// Form submission
profileForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const user = auth.currentUser;
  if(!user) {
    alert("Session expired. Please log in again.");
    window.location.href = "index.html";
    return;
  }

  // Validate username
  const username = usernameInput.value.trim();
  if(username.length < 3) {
    alert("Username must be at least 3 characters");
    return;
  }

  // Show loading state
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  try {
    let profilePictureURL = profilePicPreview.src;

    // Upload profile picture if selected
    if(profilePicInput.files[0]) {
      const file = profilePicInput.files[0];
      const storageRef = ref(storage, `profile-pictures/${user.uid}/${Date.now()}_${file.name}`);
      
      await uploadBytes(storageRef, file);
      profilePictureURL = await getDownloadURL(storageRef);
    }

    // Update Firestore
    const userRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(userRef);
    
    const userData = {
      fullName: fullNameInput.value.trim(),
      email: emailInput.value,
      username: username,
      bio: bioInput.value.trim(),
      profilePicture: profilePictureURL,
      updatedAt: new Date(),
      profileCompleted: true
    };

    if(docSnap.exists()) {
      await updateDoc(userRef, userData);
    } else {
      await setDoc(userRef, {
        ...userData,
        createdAt: new Date(),
        settings: {theme: "dark"}
      });
    }

    alert("Profile saved successfully!");
    window.location.href = "main.html";

  } catch(err) {
    console.error(err);
    alert("Failed to save profile: " + err.message);
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Profile';
  }
});
</script>

</body>
</html>