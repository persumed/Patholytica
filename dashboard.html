<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Feed â€” Patholytica</title>

<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --border-color: rgba(255,255,255,0.1);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

body.light-theme {
  --bg-color: #f5f5f5;
  --text-color: #111;
  --border-color: rgba(0,0,0,0.15);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

* { box-sizing: border-box; margin:0; padding:0; }
html, body { font-family: "Inter", Arial, sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
body { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 60px; }

/* HEADER */
.header-wrapper {
  position: sticky;
  top: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
}

.logo-link { display: inline-block; line-height: 0; }
.logo-img { height:32px; width:auto; cursor:pointer; transition:filter 0.25s ease; }
body.light-theme .logo-img { filter: invert(1); }

.theme-toggle {
  padding: 6px 14px; font-size: 12.5px; background: transparent;
  border-radius: 6px; border: 1px solid var(--border-color); color: var(--text-color); cursor:pointer; transition:0.25s ease;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }

/* FEED */
.feed-container { flex:1; max-width: 700px; margin: 0 auto; padding: 10px 14px; }

/* POSTS */
.post { border-bottom: 1px solid var(--border-color); padding: 12px 0; }
.post-header { display:flex; align-items:center; gap:10px; margin-left:6px; margin-right:6px; }
.post-avatar { width:38px; height:38px; border-radius:50%; object-fit:cover; border:1px solid var(--border-color); }
.post-author-info { flex:1; }
.post-author-name { font-weight:600; font-size:14px; }
.post-author-username { font-size:12px; color:#888; }
.post-time { font-size:12px; color:#888; }

.post-content { margin-top:6px; }
.post-text { font-size:14px; line-height:1.4; }
.post-image { width:100%; border-radius:6px; margin-top:6px; }

/* ACTIONS */
.post-actions { display:flex; gap:8px; margin-top:6px; margin-left:6px; }
.action-btn {
  display:flex; align-items:center; gap:4px;
  background:none; border:none; color:var(--text-color);
  font-size:13px; cursor:pointer; padding:2px 6px; border-radius:6px; transition:0.2s;
}
.action-btn:hover { background: rgba(176,0,58,0.1); color: var(--accent); }
.action-btn.liked { color: var(--accent); }

/* COMMENTS */
.comments-section { padding:6px 6px; }
.comments-section.hidden { display: none; }
.comment { padding:4px 0; display:flex; gap:6px; align-items:flex-start; }
.comment-avatar { width:28px; height:28px; border-radius:50%; object-fit:cover; flex-shrink:0; }
.comment-content { flex:1; }
.comment-author { font-weight:600; font-size:13px; }
.comment-text { font-size:13px; line-height:1.3; margin-top:2px; }

.comment-input-wrapper { display:flex; gap:6px; margin-top:4px; align-items:center; max-width:300px; }
.comment-input {
  flex:1; padding:6px 10px; border-radius:16px; border:1px solid var(--border-color); font-size:13px; background:var(--bg-color); color:var(--text-color);
}
.comment-submit { padding:6px 12px; font-size:13px; border-radius:16px; background:var(--accent); color:#fff; border:none; cursor:pointer; }

/* FOOTER */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  text-align: center;
  padding: 16px 10px;
  font-size: 13px;
  background: rgba(13, 13, 13, 0.85);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-top: 1px solid var(--border-color);
  transition: transform 0.3s ease;
  z-index: 30;
}

body.light-theme footer {
  background: rgba(245, 245, 245, 0.85);
}

footer.hidden {
  transform: translateY(100%);
}

footer a {
  color: var(--accent);
  text-decoration: none;
  margin: 0 8px;
  font-weight: 500;
  transition: 0.2s;
}
footer a:hover { 
  text-decoration: underline;
  color: var(--accent-hover);
}

/* MODAL */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:200; display:none; align-items:center; justify-content:center; padding:20px; }
.modal.active { display:flex; }
.modal-content { background: var(--bg-color); border-radius:16px; border:1px solid var(--border-color); padding:28px; max-width:550px; width:100%; }
.modal-header { display:flex; justify-content:space-between; margin-bottom:20px; }
.modal-close { background:none; border:none; color:var(--text-color); font-size:32px; cursor:pointer; }
.modal-textarea { width:100%; min-height:100px; padding:14px; border-radius:10px; border:1px solid var(--border-color); background:var(--bg-color); color:var(--text-color); margin-bottom:12px; }
.modal-actions { display:flex; gap:10px; justify-content:flex-end; }
.modal-btn { padding:10px 24px; border-radius:10px; border:none; font-size:14px; font-weight:600; cursor:pointer; }
.modal-btn.cancel { background:transparent; border:1px solid var(--border-color); color:var(--text-color); }
.modal-btn.submit { background:var(--accent); color:#fff; }

</style>

</head>
<body>

<!-- HEADER -->

<div class="header-wrapper">
  <div class="header">
    <a href="https://patholytica.com/main" class="logo-link"><img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo"></a>
    <button class="theme-toggle" id="themeBtn">Theme</button>
  </div>
</div>

<!-- FEED -->

<div class="feed-container" id="feedContent">Loading feed...</div>

<!-- FOOTER -->

<footer id="footer">
  <a href="https://patholytica.com/main">Home</a> | 
  <a href="#">Create</a> | 
  <a href="#">Profile</a> | 
  <a href="#">Settings</a>
</footer>

<!-- POST MODAL -->

<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Post</h2>
      <button class="modal-close" id="closeBtn">&times;</button>
    </div>
    <textarea id="postText" class="modal-textarea" placeholder="What's on your mind?"></textarea>
    <div class="modal-actions">
      <button class="modal-btn cancel" id="cancelBtn">Cancel</button>
      <button class="modal-btn submit" id="submitBtn">Post</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const supabase = createClient(
  "https://vmgenqvsmqiphcajaclx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZ2VucXZzbXFpcGhjYWphY2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTUzNzUsImV4cCI6MjA3OTI5MTM3NX0.a2FCNa6BzYqXJWPUkByxK1EiNzt1cZhc3cp2SVj-Ke4"
);

let currentUser = null;
let userLikes = new Set();

/* THEME */
const themeBtn = document.getElementById("themeBtn");
if (localStorage.getItem("theme")==="light") document.body.classList.add("light-theme");
themeBtn.onclick = () => {
  const isLight = document.body.classList.toggle("light-theme");
  localStorage.setItem("theme", isLight ? "light" : "dark");
};

/* FOOTER SCROLL BEHAVIOR */
let lastScroll = 0;
const footer = document.getElementById("footer");
window.addEventListener("scroll", () => {
  const currentScroll = window.pageYOffset;
  if (currentScroll <= 0) {
    footer.classList.remove("hidden");
    return;
  }
  if (currentScroll > lastScroll && currentScroll > 100) {
    footer.classList.add("hidden");
  } else {
    footer.classList.remove("hidden");
  }
  lastScroll = currentScroll;
});

/* MODAL */
const modal = document.getElementById("modal");
const closeBtn = document.getElementById("closeBtn");
const cancelBtn = document.getElementById("cancelBtn");

closeBtn.onclick = cancelBtn.onclick = () => modal.classList.remove("active");

/* ESCAPE HTML */
const esc = str => { const el=document.createElement("div"); el.textContent=str; return el.innerHTML; };

/* TIME AGO */
const timeAgo = date => {
  const sec = Math.floor((Date.now() - new Date(date))/1000);
  if(sec<60) return "now"; if(sec<3600) return Math.floor(sec/60)+"m";
  if(sec<86400) return Math.floor(sec/3600)+"h";
  if(sec<604800) return Math.floor(sec/86400)+"d";
  return new Date(date).toLocaleDateString();
};

/* LOAD FEED */
async function loadFeed() {
  const feed = document.getElementById("feedContent");
  try {
    const { data, error } = await supabase
      .from("posts")
      .select("*, users(name, username, profile_pic)")
      .order("created_at",{ascending:false})
      .limit(30);
    
    if(error) {
      console.error("Supabase error:", error);
      feed.innerHTML = `<div style="padding:20px;text-align:center;">Error loading feed: ${error.message}</div>`;
      return;
    }
    
    if(!data?.length){ 
      feed.innerHTML = "<div style='padding:20px;text-align:center;'>No posts yet.</div>"; 
      return; 
    }
    
    feed.innerHTML = data.map(renderPost).join("");
  } catch(err) {
    console.error("Error:", err);
    feed.innerHTML = `<div style="padding:20px;text-align:center;">Error loading feed. Please check your connection.</div>`;
  }
}

function renderPost(p){
  const u = p.users||{};
  const liked = userLikes.has(p.id);
  return `
  <div class="post" data-id="${p.id}">
    <div class="post-header">
      <img class="post-avatar" src="${u.profile_pic||"https://ui-avatars.com/api/?name="+encodeURIComponent(u.name||"User")}">
      <div class="post-author-info">
        <span class="post-author-name">${esc(u.name||"User")}</span>
        <span class="post-author-username">@${esc(u.username||"user")}</span>
      </div>
      <span class="post-time">${timeAgo(p.created_at)}</span>
    </div>
    ${(p.content||p.image_url)?`<div class="post-content">
      ${p.content?`<div class="post-text">${esc(p.content)}</div>`:""}
      ${p.image_url?`<img class="post-image" src="${p.image_url}">`:""}
    </div>`:""}
    <div class="post-actions">
      <button class="action-btn ${liked?"liked":""}" onclick="likePost('${p.id}')">Like</button>
      <button class="action-btn" onclick="toggleComments('${p.id}')">Comment</button>
    </div>
    <div class="comments-section hidden" id="c-${p.id}"><div id="cl-${p.id}"></div>
      <div class="comment-input-wrapper">
        <input class="comment-input" id="ci-${p.id}" placeholder="Add comment...">
        <button class="comment-submit" onclick="addComment('${p.id}')">Post</button>
      </div>
    </div>
  </div>`;
}

/* LIKE FUNCTION */
window.likePost = async (id) => {
  if(!currentUser) {
    alert("Please sign in to like posts");
    return;
  }
  userLikes.has(id) ? userLikes.delete(id) : userLikes.add(id);
  await loadFeed();
};

/* COMMENT FUNCTIONS */
window.toggleComments = id => {
  const sec = document.getElementById(`c-${id}`);
  sec.classList.toggle("hidden");
  if(!sec.classList.contains("hidden")) loadComments(id);
};

async function loadComments(id){
  try {
    const { data } = await supabase
      .from("comments")
      .select("*, users(name, profile_pic)")
      .eq("post_id",id)
      .order("created_at",{ascending:true});
    
    const container = document.getElementById(`cl-${id}`);
    if(data && data.length > 0) {
      container.innerHTML = data.map(c=>`
        <div class="comment">
          <img class="comment-avatar" src="${c.users?.profile_pic||"https://ui-avatars.com/api/?name="+encodeURIComponent(c.users?.name||"User")}">
          <div class="comment-content">
            <span class="comment-author">${esc(c.users?.name||"User")}</span>
            <div class="comment-text">${esc(c.content)}</div>
          </div>
        </div>`).join("");
    } else {
      container.innerHTML = "";
    }
  } catch(err) {
    console.error("Error loading comments:", err);
  }
}

window.addComment = async id=>{
  if(!currentUser) {
    alert("Please sign in to comment");
    return;
  }
  const input=document.getElementById(`ci-${id}`);
  if(!input.value.trim()) return;
  
  try {
    await supabase.from("comments").insert({
      post_id:id,
      firebase_uid:currentUser.uid,
      content:input.value
    });
    input.value=""; 
    loadComments(id);
  } catch(err) {
    console.error("Error adding comment:", err);
    alert("Failed to add comment");
  }
};

/* AUTH STATE */
onAuthStateChanged(auth, async user => {
  currentUser = user;
  await loadFeed();
});
</script>

</body>
</html>