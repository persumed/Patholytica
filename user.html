<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Feed ‚Äî Patholytica</title>

<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --border-color: rgba(255,255,255,0.1);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

body.light-theme {
  --bg-color: #f5f5f5;
  --text-color: #111;
  --border-color: rgba(0,0,0,0.15);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

* { box-sizing: border-box; margin:0; padding:0; }
html { scroll-behavior: auto; }
html, body { font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; }
body { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 80px; }

/* HEADER */
.header-wrapper {
  position: sticky;
  top: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  transition: transform 0.3s ease;
}

.header-wrapper.hidden {
  transform: translateY(-100%);
}

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.logo-link { display: inline-block; line-height: 0; }
.logo-img { height:36px; width:auto; cursor:pointer; transition:filter 0.25s ease, transform 0.2s; }
.logo-img:hover { transform: scale(1.05); }
body.light-theme .logo-img { filter: invert(1); }

/* BURGER MENU */
.burger-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  z-index: 60;
  transition: 0.3s;
}

.burger-line {
  width: 24px;
  height: 2px;
  background: var(--text-color);
  border-radius: 2px;
  transition: 0.3s;
}

.burger-btn.active .burger-line:nth-child(1) {
  transform: rotate(45deg) translate(7px, 7px);
}

.burger-btn.active .burger-line:nth-child(2) {
  opacity: 0;
}

.burger-btn.active .burger-line:nth-child(3) {
  transform: rotate(-45deg) translate(7px, -7px);
}

/* MENU DROPDOWN */
.menu-dropdown {
  position: fixed;
  top: 0;
  right: -100%;
  width: 280px;
  height: 100vh;
  background: var(--bg-color);
  border-left: 1px solid var(--border-color);
  z-index: 50;
  transition: right 0.3s ease;
  padding-top: calc(env(safe-area-inset-top) + 70px);
  box-shadow: -4px 0 20px rgba(0,0,0,0.3);
}

.menu-dropdown.active {
  right: 0;
}

.menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 45;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.menu-overlay.active {
  opacity: 1;
  pointer-events: all;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 24px;
  color: var(--text-color);
  text-decoration: none;
  font-size: 15px;
  font-weight: 500;
  transition: 0.2s;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
}

.menu-item:hover {
  background: rgba(176,0,58,0.1);
  color: var(--accent);
}

.menu-icon {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

/* FEED */
.feed-container { flex:1; max-width: 700px; margin: 0 auto; padding: 16px 20px; width: 100%; }

/* POSTS */
.post { 
  border-bottom: 1px solid var(--border-color); 
  padding: 16px 0;
  transition: background 0.2s;
}

.post:hover {
  background: rgba(255,255,255,0.02);
}

body.light-theme .post:hover {
  background: rgba(0,0,0,0.02);
}

.post-header { display:flex; align-items:center; gap:12px; margin-left:6px; margin-right:6px; }
.post-avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; border:2px solid var(--border-color); }
.post-author-info { flex:1; }
.post-author-name { font-weight:600; font-size:15px; }
.post-author-username { font-size:13px; color:#888; margin-left: 6px; }
.post-time { font-size:13px; color:#888; }

.post-content { margin-top:10px; }
.post-text { font-size:15px; line-height:1.5; }
.post-image { width:100%; border-radius:12px; margin-top:10px; border: 1px solid var(--border-color); }

/* ACTIONS */
.post-actions { display:flex; gap:12px; margin-top:12px; margin-left:6px; }
.action-btn {
  display:flex; align-items:center; gap:6px;
  background:none; border:none; color:var(--text-color);
  font-size:14px; cursor:pointer; padding:6px 12px; border-radius:8px; transition:0.2s;
  font-weight: 500;
}
.action-btn:hover { background: rgba(176,0,58,0.1); color: var(--accent); }
.action-btn.liked { color: var(--accent); font-weight: 600; }

/* COMMENTS */
.comments-section { padding:10px 6px; }
.comments-section.hidden { display: none; }
.comment { padding:8px 0; display:flex; gap:10px; align-items:flex-start; }
.comment-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; flex-shrink:0; border: 1px solid var(--border-color); }
.comment-content { flex:1; }
.comment-author { font-weight:600; font-size:14px; }
.comment-text { font-size:14px; line-height:1.4; margin-top:3px; }

.comment-input-wrapper { display:flex; gap:8px; margin-top:8px; align-items:center; }
.comment-input {
  flex:1; padding:8px 14px; border-radius:20px; border:1px solid var(--border-color); font-size:14px; background:var(--bg-color); color:var(--text-color);
  transition: border-color 0.2s;
}
.comment-input:focus {
  outline: none;
  border-color: var(--accent);
}
.comment-submit { 
  padding:8px 16px; font-size:14px; border-radius:20px; background:var(--accent); color:#fff; border:none; cursor:pointer; font-weight: 600;
  transition: background 0.2s;
}
.comment-submit:hover {
  background: var(--accent-hover);
}

/* FOOTER */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  padding: 20px;
  background: rgba(13, 13, 13, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-color);
  transition: transform 0.3s ease;
  z-index: 30;
  padding-bottom: calc(20px + env(safe-area-inset-bottom));
}

body.light-theme footer {
  background: rgba(245, 245, 245, 0.95);
}

footer.hidden {
  transform: translateY(100%);
}

.footer-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 28px;
  border-radius: 25px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
}

.footer-btn.home {
  background: transparent;
  color: var(--text-color);
  border: 2px solid var(--border-color);
}

.footer-btn.home:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-2px);
}

.footer-btn.create {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 4px 12px rgba(176,0,58,0.3);
}

.footer-btn.create:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(176,0,58,0.4);
}

.footer-icon {
  font-size: 18px;
}

/* MODAL */
.modal { 
  position:fixed; 
  inset:0; 
  background:rgba(0,0,0,0.75); 
  backdrop-filter: blur(4px);
  z-index:200; 
  display:none; 
  align-items:center; 
  justify-content:center; 
  padding:20px;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal.active { display:flex; }
.modal-content { 
  background: var(--bg-color); 
  border-radius:20px; 
  border:1px solid var(--border-color); 
  padding:32px; 
  max-width:550px; 
  width:100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header { 
  display:flex; 
  justify-content:space-between; 
  align-items: center;
  margin-bottom:24px; 
}

.modal-header h2 {
  font-size: 22px;
  font-weight: 700;
}

.modal-close { 
  background:none; 
  border:none; 
  color:var(--text-color); 
  font-size:28px; 
  cursor:pointer;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: 0.2s;
}

.modal-close:hover {
  background: rgba(255,255,255,0.1);
}

.modal-textarea { 
  width:100%; 
  min-height:120px; 
  padding:16px; 
  border-radius:12px; 
  border:1px solid var(--border-color); 
  background:var(--bg-color); 
  color:var(--text-color); 
  margin-bottom:16px;
  font-size: 15px;
  font-family: inherit;
  resize: vertical;
  transition: border-color 0.2s;
}

.modal-textarea:focus {
  outline: none;
  border-color: var(--accent);
}

/* IMAGE UPLOAD */
.image-upload-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 16px;
  background: var(--bg-color);
  color: var(--text-color);
  transition: 0.2s;
}

.image-upload-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.image-preview {
  max-width: 100%;
  border-radius: 10px;
  display: none;
  margin-bottom: 16px;
  border: 1px solid var(--border-color);
}

.modal-actions { display:flex; gap:12px; justify-content:flex-end; }
.modal-btn { 
  padding:12px 28px; 
  border-radius:12px; 
  border:none; 
  font-size:15px; 
  font-weight:600; 
  cursor:pointer;
  transition: all 0.2s;
}
.modal-btn.cancel { 
  background:transparent; 
  border:2px solid var(--border-color); 
  color:var(--text-color); 
}
.modal-btn.cancel:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.modal-btn.submit { 
  background:var(--accent); 
  color:#fff;
}
.modal-btn.submit:hover {
  background: var(--accent-hover);
  transform: translateY(-1px);
}

@media (max-width: 600px) {
  .footer-btn {
    padding: 10px 20px;
    font-size: 14px;
  }
  
  .menu-dropdown {
    width: 100%;
  }
}
</style>

</head>
<body>

<!-- HEADER -->

<div class="header-wrapper" id="headerWrapper">
  <div class="header">
    <a href="https://patholytica.com/main" class="logo-link">
      <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo">
    </a>
    <button class="burger-btn" id="burgerBtn">
      <span class="burger-line"></span>
      <span class="burger-line"></span>
      <span class="burger-line"></span>
    </button>
  </div>
</div>

<!-- MENU OVERLAY -->

<div class="menu-overlay" id="menuOverlay"></div>

<!-- MENU DROPDOWN -->

<div class="menu-dropdown" id="menuDropdown">
  <a href="#" class="menu-item" id="profileBtn">
    <span class="menu-icon">üë§</span>
    <span>Profile</span>
  </a>
  <a href="#" class="menu-item" id="settingsBtn">
    <span class="menu-icon">‚öôÔ∏è</span>
    <span>Settings</span>
  </a>
  <div class="menu-item" id="themeBtn">
    <span class="menu-icon">üåì</span>
    <span id="themeText">Light Theme</span>
  </div>
</div>

<!-- FEED -->

<div class="feed-container" id="feedContent">Loading feed...</div>

<!-- FOOTER -->

<footer id="footer">
  <a href="https://patholytica.com/main" class="footer-btn home">
    <span class="footer-icon">üè†</span>
    <span>Home</span>
  </a>
  <button class="footer-btn create" id="createBtn">
    <span class="footer-icon">‚úèÔ∏è</span>
    <span>Create</span>
  </button>
</footer>

<!-- POST MODAL -->

<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Post</h2>
      <button class="modal-close" id="closeBtn">&times;</button>
    </div>
    <textarea id="postText" class="modal-textarea" placeholder="What's on your mind?"></textarea>

```
<label class="image-upload-btn" for="postImg">üì∑ Add Image</label>
<input type="file" id="postImg" accept="image/*" style="display:none;">
<img id="imgPreview" class="image-preview">

<div class="modal-actions">
  <button class="modal-btn cancel" id="cancelBtn">Cancel</button>
  <button class="modal-btn submit" id="submitBtn">Post</button>
</div>
```

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const supabase = createClient(
  "https://vmgenqvsmqiphcajaclx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZ2VucXZzbXFpcGhjYWphY2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTUzNzUsImV4cCI6MjA3OTI5MTM3NX0.a2FCNa6BzYqXJWPUkByxK1EiNzt1cZhc3cp2SVj-Ke4"
);

let currentUser = null;
let userLikes = new Set();

/* BURGER MENU */
const burgerBtn = document.getElementById("burgerBtn");
const menuDropdown = document.getElementById("menuDropdown");
const menuOverlay = document.getElementById("menuOverlay");

function toggleMenu() {
  burgerBtn.classList.toggle("active");
  menuDropdown.classList.toggle("active");
  menuOverlay.classList.toggle("active");
}

burgerBtn.onclick = toggleMenu;
menuOverlay.onclick = toggleMenu;

/* THEME */
const themeBtn = document.getElementById("themeBtn");
const themeText = document.getElementById("themeText");

function updateThemeText() {
  themeText.textContent = document.body.classList.contains("light-theme") ? "Dark Theme" : "Light Theme";
}

if (localStorage.getItem("theme")==="light") {
  document.body.classList.add("light-theme");
  updateThemeText();
}

themeBtn.onclick = () => {
  const isLight = document.body.classList.toggle("light-theme");
  localStorage.setItem("theme", isLight ? "light" : "dark");
  updateThemeText();
};

/* MENU ITEMS */
document.getElementById("profileBtn").onclick = (e) => {
  e.preventDefault();
  toggleMenu();
  alert("Profile page - Coming soon!");
};

document.getElementById("settingsBtn").onclick = (e) => {
  e.preventDefault();
  toggleMenu();
  alert("Settings page - Coming soon!");
};

/* HEADER SCROLL BEHAVIOR */
let lastScroll = 0;
const headerWrapper = document.getElementById("headerWrapper");
const footer = document.getElementById("footer");

window.addEventListener("scroll", () => {
  const currentScroll = window.pageYOffset;
  
  if (currentScroll <= 0) {
    headerWrapper.classList.remove("hidden");
    footer.classList.remove("hidden");
    lastScroll = currentScroll;
    return;
  }
  
  if (currentScroll > lastScroll && currentScroll > 100) {
    headerWrapper.classList.add("hidden");
    footer.classList.add("hidden");
  } else {
    headerWrapper.classList.remove("hidden");
    footer.classList.remove("hidden");
  }
  
  lastScroll = currentScroll;
});

/* CREATE POST */
const modal = document.getElementById("modal");
const closeBtn = document.getElementById("closeBtn");
const cancelBtn = document.getElementById("cancelBtn");
const createBtn = document.getElementById("createBtn");
const submitBtn = document.getElementById("submitBtn");
const postText = document.getElementById("postText");
const postImg = document.getElementById("postImg");
const imgPreview = document.getElementById("imgPreview");

createBtn.onclick = () => {
  if(!currentUser) {
    alert("Please sign in to create a post");
    return;
  }
  modal.classList.add("active");
};

closeBtn.onclick = cancelBtn.onclick = () => {
  modal.classList.remove("active");
  postText.value = "";
  postImg.value = "";
  imgPreview.style.display = "none";
};

/* IMAGE PREVIEW */
postImg.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) {
    alert("Image must be under 5MB");
    postImg.value = "";
    return;
  }
  imgPreview.src = URL.createObjectURL(file);
  imgPreview.style.display = "block";
};

submitBtn.onclick = async () => {
  if(!postText.value.trim() && !postImg.files[0]) {
    alert("Please enter some content or upload an image");
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.textContent = "Posting...";
  
  try {
    let imageUrl = null;

    if (postImg.files[0]) {
      const file = postImg.files[0];
      const ext = file.name.split(".").pop();
      const path = `posts/${currentUser.uid}/${Date.now()}.${ext}`;

      const { error: upErr } = await supabase.storage
        .from("posts")
        .upload(path, file);

      if (upErr) throw upErr;

      const { data } = supabase.storage.from("posts").getPublicUrl(path);
      imageUrl = data.publicUrl;
    }

    const { error } = await supabase.from("posts").insert({
      firebase_uid: currentUser.uid,
      content: postText.value.trim() || null,
      image_url: imageUrl,
      created_at: new Date().toISOString()
    });
    
    if(error) throw error;
    
    modal.classList.remove("active");
    postText.value = "";
    postImg.value = "";
    imgPreview.style.display = "none";
    await loadFeed();
    alert("Post created successfully!");
  } catch(err) {
    console.error("Error creating post:", err);
    alert("Failed to create post. Please try again.");
  }
  
  submitBtn.disabled = false;
  submitBtn.textContent = "Post";
};

/* ESCAPE HTML */
const esc = str => { const el=document.createElement("div"); el.textContent=str; return el.innerHTML; };

/* TIME AGO */
const timeAgo = date => {
  const sec = Math.floor((Date.now() - new Date(date))/1000);
  if(sec<60) return "now"; if(sec<3600) return Math.floor(sec/60)+"m";
  if(sec<86400) return Math.floor(sec/3600)+"h";
  if(sec<604800) return Math.floor(sec/86400)+"d";
  return new Date(date).toLocaleDateString();
};

/* LOAD FEED */
async function loadFeed() {
  const feed = document.getElementById("feedContent");
  try {
    const { data, error } = await supabase
      .from("posts")
      .select("*, users(name, username, profile_pic)")
      .order("created_at",{ascending:false})
      .limit(30);
    
    if(error) {
      console.error("Supabase error:", error);
      feed.innerHTML = `<div style="padding:20px;text-align:center;">Error loading feed: ${error.message}</div>`;
      return;
    }
    
    if(!data?.length){ 
      feed.innerHTML = "<div style='padding:20px;text-align:center;'>No posts yet. Be the first to post!</div>"; 
      return; 
    }
    
    feed.innerHTML = data.map(renderPost).join("");
  } catch(err) {
    console.error("Error:", err);
    feed.innerHTML = `<div style="padding:20px;text-align:center;">Error loading feed. Please check your connection.</div>`;
  }
}

function renderPost(p){
  const u = p.users||{};
  const liked = userLikes.has(p.id);
  return `
  <div class="post" data-id="${p.id}">
    <div class="post-header">
      <img class="post-avatar" src="${u.profile_pic||"https://ui-avatars.com/api/?name="+encodeURIComponent(u.name||"User")}">
      <div class="post-author-info">
        <span class="post-author-name">${esc(u.name||"User")}</span>
        <span class="post-author-username">@${esc(u.username||"user")}</span>
      </div>
      <span class="post-time">${timeAgo(p.created_at)}</span>
    </div>
    ${(p.content||p.image_url)?`<div class="post-content">
      ${p.content?`<div class="post-text">${esc(p.content)}</div>`:""}
      ${p.image_url?`<img class="post-image" src="${p.image_url}">`:""}
    </div>`:""}
    <div class="post-actions">
      <button class="action-btn ${liked?"liked":""}" onclick="likePost('${p.id}')">‚ô• Like</button>
      <button class="action-btn" onclick="toggleComments('${p.id}')">üí¨ Comment</button>
    </div>
    <div class="comments-section hidden" id="c-${p.id}"><div id="cl-${p.id}"></div>
      <div class="comment-input-wrapper">
        <input class="comment-input" id="ci-${p.id}" placeholder="Add comment...">
        <button class="comment-submit" onclick="addComment('${p.id}')">Post</button>
      </div>
    </div>
  </div>`;
}

/* LIKE FUNCTION */
window.likePost = async (id) => {
  if(!currentUser) {
    alert("Please sign in to like posts");
    return;
  }
  userLikes.has(id) ? userLikes.delete(id) : userLikes.add(id);
  await loadFeed();
};

/* COMMENT FUNCTIONS */
window.toggleComments = id => {
  const sec = document.getElementById(`c-${id}`);
  sec.classList.toggle("hidden");
  if(!sec.classList.contains("hidden")) loadComments(id);
};

async function loadComments(id){
  try {
    const { data } = await supabase
      .from("comments")
      .select("*, users(name, profile_pic)")
      .eq("post_id",id)
      .order("created_at",{ascending:true});
    
    const container = document.getElementById(`cl-${id}`);
    if(data && data.length > 0) {
      container.innerHTML = data.map(c=>`
        <div class="comment">
          <img class="comment-avatar" src="${c.users?.profile_pic||"https://ui-avatars.com/api/?name="+encodeURIComponent(c.users?.name||"User")}">
          <div class="comment-content">
            <span class="comment-author">${esc(c.users?.name||"User")}</span>
            <div class="comment-text">${esc(c.content)}</div>
          </div>
        </div>`).join("");
    } else {
      container.innerHTML = "";
    }
  } catch(err) {
    console.error("Error loading comments:", err);
  }
}

window.addComment = async id=>{
  if(!currentUser) {
    alert("Please sign in to comment");
    return;
  }
  const input=document.getElementById(`ci-${id}`);
  if(!input.value.trim()) return;
  
  try {
    await supabase.from("comments").insert({
      post_id:id,
      firebase_uid:currentUser.uid,
      content:input.value
    });
    input.value=""; 
    loadComments(id);
  } catch(err) {
    console.error("Error adding comment:", err);
    alert("Failed to add comment");
  }
};

/* AUTH STATE */
onAuthStateChanged(auth, async user => {
  currentUser = user;
  await loadFeed();
});
</script>

</body>
</html>