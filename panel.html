<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica â€” Academic Libraries</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --bg-color: #0f0f0f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --card-bg: #1f1f1f;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --accent-hover: #2d8ed6;
}
body.light-theme {
  --bg-color: #ffffff;
  --text-primary: #0f0f0f;
  --text-secondary: #606060;
  --card-bg: #f9f9f9;
  --hover-bg: #f0f0f0;
  --border-color: #e5e5e5;
  --accent: #065fd4;
  --accent-hover: #0448a3;
}
* { box-sizing: border-box; }
html, body { margin:0; padding:0; min-height:100%; font-family: "Roboto", Arial, sans-serif; }
body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}
.header-wrapper {
  position: sticky;
  top: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  max-width: 1400px;
  margin: 0 auto;
}
.logo-img {
  height: 28px;
  width: auto;
  transition: filter 0.2s ease;
  cursor: pointer;
}
body.light-theme .logo-img {
  filter: invert(1);
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: background 0.2s ease;
}
.icon-btn:hover {
  background: var(--hover-bg);
}
.search-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 50;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.search-overlay.active {
  display: flex;
  opacity: 1;
}
.search-container {
  width: 100%;
  max-width: 700px;
  margin: 80px auto 0;
  padding: 0 24px;
  transform: translateY(-20px);
  transition: transform 0.3s ease;
}
.search-overlay.active .search-container {
  transform: translateY(0);
}
.search-bar-header {
  background: var(--card-bg);
  border-radius: 24px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
}
.search-bar-header input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-primary);
  font-size: 16px;
  outline: none;
}
.search-bar-header input::placeholder {
  color: var(--text-secondary);
}
.search-close-btn {
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 20px;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.tabs-nav {
  display: flex;
  gap: 0;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 24px;
  border-bottom: 1px solid var(--border-color);
}
.tab-btn {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  padding: 16px 24px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}
.tab-btn:hover {
  color: var(--text-primary);
}
.tab-btn.active {
  color: var(--text-primary);
  border-bottom-color: var(--accent);
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.user-menu {
  position: relative;
}
.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 500;
  color: white;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.user-avatar:hover {
  transform: scale(1.05);
}
.login-icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s ease;
}
.login-icon-btn:hover {
  background: var(--hover-bg);
  transform: scale(1.05);
}
.login-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.login-popup-overlay.active {
  display: flex;
  opacity: 1;
}
.login-popup {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 32px;
  max-width: 420px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  transform: scale(0.9);
  transition: transform 0.3s ease;
  max-height: 90vh;
  overflow-y: auto;
}
.login-popup-overlay.active .login-popup {
  transform: scale(1);
}
.login-popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}
.login-popup-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0;
}
.login-popup-close {
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 24px;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s ease;
}
.login-popup-close:hover {
  background: var(--hover-bg);
}
.login-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.login-option-btn {
  width: 100%;
  padding: 14px 20px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: transparent;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  transition: all 0.2s ease;
  position: relative;
}
.login-option-btn:hover:not(:disabled) {
  background: var(--hover-bg);
  border-color: var(--accent);
}
.login-option-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.login-option-btn i {
  font-size: 18px;
}
.google-btn {
  background: #4285F4;
  border-color: #4285F4;
  color: white;
}
.google-btn:hover:not(:disabled) {
  background: #357ae8;
  border-color: #357ae8;
}
.spinner {
  display: none;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 0.8s linear infinite;
  position: absolute;
  right: 20px;
}
.spinner.show {
  display: inline-block;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.login-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 16px 0;
  color: var(--text-secondary);
  font-size: 13px;
}
.login-divider::before,
.login-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border-color);
}
.input-field {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: var(--hover-bg);
  color: var(--text-primary);
  font-size: 14px;
  transition: 0.2s ease;
}
.input-field:focus {
  border-color: var(--accent);
  outline: none;
  box-shadow: 0 0 0 3px rgba(58, 166, 255, 0.1);
}
.input-field::placeholder {
  color: var(--text-secondary);
}
.login-form-content {
  display: none;
}
.login-form-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.form-link {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
}
.form-link:hover {
  text-decoration: underline;
}
.back-link {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 12px;
}
.back-link:hover {
  color: var(--text-primary);
}
.terms-checkbox {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin: 16px 0;
  font-size: 13px;
  color: var(--text-secondary);
}
.terms-checkbox input {
  margin-top: 2px;
}
.dropdown-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  min-width: 200px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
  z-index: 100;
}
.dropdown-menu.show {
  display: block;
}
.dropdown-item {
  padding: 12px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-primary);
  text-decoration: none;
  transition: background 0.2s ease;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-size: 14px;
}
.dropdown-item:hover {
  background: var(--hover-bg);
}
.dropdown-divider {
  height: 1px;
  background: var(--border-color);
  margin: 4px 0;
}
.user-info {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-color);
}
.user-name {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 2px;
}
.user-email {
  font-size: 12px;
  color: var(--text-secondary);
}
.main-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 24px 60px;
}
.hero-section {
  margin-bottom: 48px;
}
.hero-section h1 {
  font-size: 32px;
  margin: 0 0 8px 0;
  font-weight: 500;
}
.hero-section p {
  font-size: 15px;
  color: var(--text-secondary);
  margin: 0;
  line-height: 1.6;
}
.section-header {
  margin-bottom: 20px;
}
.section-title {
  font-size: 20px;
  font-weight: 500;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-icon {
  font-size: 20px;
}
.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
  margin-bottom: 48px;
}
.library-card {
  background: transparent;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s ease;
  text-decoration: none;
  color: var(--text-primary);
  display: block;
}
.library-card:hover {
  transform: scale(1.02);
}
.library-card:hover .library-thumbnail {
  transform: scale(1.05);
}
.library-thumbnail-wrapper {
  width: 100%;
  height: 180px;
  overflow: hidden;
  border-radius: 12px;
  background: var(--card-bg);
  position: relative;
}
.library-thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}
.library-duration {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}
.library-content {
  padding: 12px 0;
}
.library-header {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}
.author-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 500;
  color: white;
  flex-shrink: 0;
}
.library-info {
  flex: 1;
  min-width: 0;
}
.library-title {
  font-size: 15px;
  font-weight: 500;
  margin: 0 0 4px 0;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.library-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-secondary);
  flex-wrap: wrap;
}
.meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.meta-separator {
  width: 3px;
  height: 3px;
  border-radius: 50%;
  background: var(--text-secondary);
}
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}
.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.message-item {
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  gap: 12px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.message-item:hover {
  background: var(--hover-bg);
}
.message-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 500;
  color: white;
  flex-shrink: 0;
}
.message-content {
  flex: 1;
  min-width: 0;
}
.message-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 4px;
}
.message-name {
  font-weight: 500;
  font-size: 15px;
}
.message-time {
  font-size: 12px;
  color: var(--text-secondary);
}
.message-preview {
  font-size: 14px;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-color);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--border-color);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
#notificationArea {
  position: fixed;
  top: calc(70px + env(safe-area-inset-top));
  right: 20px;
  z-index: 100;
  max-width: 400px;
}
.notification {
  background: var(--card-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  gap: 12px;
  transform: translateX(450px);
  transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  font-size: 14px;
}
.notification.show {
  transform: translateX(0);
}
.notification-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.notification.success .notification-dot {
  background: #10b981;
}
.notification.error .notification-dot {
  background: #ef4444;
}
.notification.info .notification-dot {
  background: #3b82f6;
}
.notification.warning .notification-dot {
  background: #f59e0b;
}
.notification-message {
  flex: 1;
  line-height: 1.4;
}
@media (max-width: 768px) {
  .hero-section h1 { font-size: 26px; }
  .library-grid {
    grid-template-columns: 1fr;
  }
  .header {
    padding: 12px 16px;
  }
  .main-container {
    padding: 24px 16px 48px;
  }
  .tabs-nav {
    padding: 0 16px;
  }
  #notificationArea {
    left: 16px;
    right: 16px;
    max-width: none;
  }
  .login-popup {
    padding: 24px;
  }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
</div>

<div id="notificationArea"></div>

<div class="search-overlay" id="searchOverlay">
  <div class="search-container">
    <div class="search-bar-header">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Search libraries..." id="searchInput" />
      <button class="search-close-btn" onclick="closeSearch()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>

<div class="login-popup-overlay" id="loginPopup">
  <div class="login-popup">
    <div id="loginInitial" class="login-form-content active">
      <div class="login-popup-header">
        <h2 class="login-popup-title">Sign In</h2>
        <button class="login-popup-close" onclick="closeLoginPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="login-options">
        <button class="login-option-btn google-btn" id="googleLoginBtn">
          <i class="fab fa-google"></i>
          <span>Continue with Google</span>
          <div class="spinner" id="googleSpinner"></div>
        </button>
        <div class="login-divider"><span>or</span></div>
        <button class="login-option-btn" onclick="showEmailLogin()">
          <i class="fas fa-envelope"></i>
          Continue with Email
        </button>
        <button class="login-option-btn" onclick="showSignupForm()">
          <i class="fas fa-user-plus"></i>
          Create Account
        </button>
      </div>
    </div>

    <div id="loginEmailForm" class="login-form-content">
      <div class="login-popup-header">
        <h2 class="login-popup-title">Login</h2>
        <button class="login-popup-close" onclick="closeLoginPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="emailLoginForm">
        <input type="email" class="input-field" id="loginEmail" placeholder="Email Address" required>
        <input type="password" class="input-field" id="loginPassword" placeholder="Password" required>
        <button type="submit" class="login-option-btn" id="loginSubmitBtn" style="margin-top: 12px;">
          <span>Continue</span>
          <div class="spinner" id="loginSpinner"></div>
        </button>
      </form>
      <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary); text-align: center;">
        Don't have an account? 
        <a href="#" class="form-link" onclick="event.preventDefault(); showSignupForm();">Sign up</a>
      </p>
      <a href="#" class="back-link" onclick="event.preventDefault(); showLoginInitial();">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>

    <div id="signupFormContainer" class="login-form-content">
      <div class="login-popup-header">
        <h2 class="login-popup-title">Create Account</h2>
        <button class="login-popup-close" onclick="closeLoginPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="signupForm">
        <input type="text" class="input-field" id="signupName" placeholder="Full Name" required>
        <input type="email" class="input-field" id="signupEmail" placeholder="Email Address" required>
        <input type="text" class="input-field" id="signupUsername" placeholder="Username" required>
        <input type="password" class="input-field" id="signupPassword" placeholder="Password (min. 8 characters)" minlength="8" required>
        <input type="password" class="input-field" id="signupConfirm" placeholder="Confirm Password" required>
        <label class="terms-checkbox">
          <input type="checkbox" id="termsCheckbox" required>
          <span>I agree to the <a href="#" class="form-link">Terms</a> and <a href="#" class="form-link">Privacy Policy</a></span>
        </label>
        <button type="submit" class="login-option-btn" id="signupSubmitBtn">
          <span>Create Account</span>
          <div class="spinner" id="signupSpinner"></div>
        </button>
      </form>
      <p style="margin-top: 16px; font-size: 14px; color: var(--text-secondary); text-align: center;">
        Already have an account?
        <a href="#" class="form-link" onclick="event.preventDefault(); showEmailLogin();">Login</a>
      </p>
      <a href="#" class="back-link" onclick="event.preventDefault(); showLoginInitial();">
        <i class="fas fa-arrow-left"></i> Back
      </a>
    </div>
  </div>
</div>

<div class="header-wrapper">
  <div class="header">
    <a href="https://patholytica.com">
      <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo">
    </a>
    <div class="header-actions">
      <button class="icon-btn" onclick="openSearch()" title="Search">
        <i class="fas fa-search"></i>
      </button>
      <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-circle-half-stroke"></i>
      </button>
      <div class="user-menu" id="userMenuContainer" style="display: none;">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
        <div class="dropdown-menu" id="userDropdown">
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-email" id="userEmail">Loading...</div>
          </div>
          <a href="dashboard.html" class="dropdown-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
          </a>
          <a href="#" class="dropdown-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>Sign Out</span>
          </button>
        </div>
      </div>
      <button class="login-icon-btn" id="loginButton" style="display: none;" onclick="openLoginPopup()" title="Login">
        <i class="fas fa-arrow-right-to-bracket"></i>
      </button>
    </div>
  </div>
  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab('explore')">
      <i class="fas fa-compass"></i>
      Explore
    </button>
    <button class="tab-btn" onclick="switchTab('home')">
      <i class="fas fa-home"></i>
      Home
    </button>
    <button class="tab-btn" onclick="switchTab('messages')">
      <i class="fas fa-message"></i>
      Messages
    </button>
  </div>
</div>

<div class="main-container">
  <div class="tab-content active" id="exploreTab">
    <div class="hero-section">
      <h1>Academic Libraries</h1>
      <p>Explore curated collections of research data, case studies, and academic resources.</p>
    </div>
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-clock section-icon"></i>
        Latest Libraries
      </h2>
    </div>
    <div class="library-grid" id="latestLibraries"></div>
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-fire section-icon"></i>
        Most Popular
      </h2>
    </div>
    <div class="library-grid" id="popularLibraries"></div>
  </div>

  <div class="tab-content" id="homeTab">
    <div class="hero-section">
      <h1>My Libraries</h1>
      <p>Your saved libraries and collections.</p>
    </div>
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-bookmark section-icon"></i>
        Saved Libraries
      </h2>
    </div>
    <div class="library-grid" id="savedLibraries">
      <div class="empty-state" style="grid-column: 1/-1;">
        <i class="fas fa-bookmark"></i>
        <p>No saved libraries yet. Start exploring and save your favorites!</p>
      </div>
    </div>
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-history section-icon"></i>
        Recently Viewed
      </h2>
    </div>
    <div class="library-grid" id="recentLibraries">
      <div class="empty-state" style="grid-column: 1/-1;">
        <i class="fas fa-history"></i>
        <p>No viewing history yet.</p>
      </div>
    </div>
  </div>

  <div class="tab-content" id="messagesTab">
    <div class="hero-section">
      <h1>Messages</h1>
      <p>Connect with researchers and collaborators.</p>
    </div>
    <div id="messagesList">
      <div class="message-item">
        <div class="message-avatar">SM</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-name">Dr. Sarah Mitchell</span>
            <span class="message-time">2h ago</span>
          </div>
          <div class="message-preview">Thanks for sharing the cardiovascular dataset. I found some interesting patterns...</div>
        </div>
      </div>
      <div class="message-item">
        <div class="message-avatar">JC</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-name">Dr. James Chen</span>
            <span class="message-time">1d ago</span>
          </div>
          <div class="message-preview">Would you be interested in collaborating on the neurological study?</div>
        </div>
      </div>
      <div class="message-item">
        <div class="message-avatar">ER</div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-name">Dr. Emily Rodriguez</span>
            <span class="message-time">3d ago</span>
          </div>
          <div class="message-preview">I've updated the oncology repository with new case studies.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { 
  getAuth, 
  onAuthStateChanged,
  signOut,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

setTimeout(() => {
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay && loadingOverlay.style.display !== 'none') {
    loadingOverlay.style.display = 'none';
  }
}, 3000);

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

let isProcessingRedirect = false;
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

function showNotification(message, type = 'info') {
  const notificationArea = document.getElementById('notificationArea');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-dot"></div>
    <span class="notification-message">${message}</span>
  `;
  notificationArea.appendChild(notification);
  setTimeout(() => notification.classList.add('show'), 10);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }, 5000);
}

window.showNotification = showNotification;

window.switchTab = function(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  const tabBtns = document.querySelectorAll('.tab-btn');
  tabs.forEach(tab => tab.classList.remove('active'));
  tabBtns.forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
  event.target.closest('.tab-btn').classList.add('active');
};

window.openSearch = function() {
  const overlay = document.getElementById('searchOverlay');
  overlay.classList.add('active');
  setTimeout(() => document.getElementById('searchInput').focus(), 100);
};

window.closeSearch = function() {
  const overlay = document.getElementById('searchOverlay');
  overlay.classList.remove('active');
  document.getElementById('searchInput').value = '';
  renderLibraries();
};

window.openLoginPopup = function() {
  const popup = document.getElementById('loginPopup');
  popup.classList.add('active');
  showLoginInitial();
};

window.closeLoginPopup = function() {
  const popup = document.getElementById('loginPopup');
  popup.classList.remove('active');
  setTimeout(() => {
    showLoginInitial();
    document.getElementById('emailLoginForm').reset();
    document.getElementById('signupForm').reset();
  }, 300);
};

window.showLoginInitial = function() {
  document.querySelectorAll('.login-form-content').forEach(el => el.classList.remove('active'));
  document.getElementById('loginInitial').classList.add('active');
};

window.showEmailLogin = function() {
  document.querySelectorAll('.login-form-content').forEach(el => el.classList.remove('active'));
  document.getElementById('loginEmailForm').classList.add('active');
};

window.showSignupForm = function() {
  document.querySelectorAll('.login-form-content').forEach(el => el.classList.remove('active'));
  document.getElementById('signupFormContainer').classList.add('active');
};

document.getElementById('searchOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeSearch();
});

document.getElementById('loginPopup').addEventListener('click', function(e) {
  if (e.target === this) closeLoginPopup();
});

(async function checkRedirectResult() {
  if (isProcessingRedirect) return;
  isProcessingRedirect = true;
  try {
    const result = await getRedirectResult(auth);
    if (result && result.user) {
      console.log("Google User signed in via redirect:", result.user.email);
      showNotification("Welcome to Patholytica!", "success");
      setTimeout(() => window.location.href = "dashboard.html", 1500);
    }
  } catch (error) {
    console.error("Redirect sign-in error:", error);
    if (error.code && error.code !== 'auth/cancelled-popup-request') {
      let errorMessage = 'Sign-in failed. ';
      switch (error.code) {
        case 'auth/account-exists-with-different-credential':
          errorMessage += 'Account exists with different sign-in method.';
          break;
        case 'auth/popup-blocked':
          errorMessage += 'Popup was blocked by browser.';
          break;
        default:
          errorMessage += error.message;
      }
      showNotification(errorMessage, "error");
    }
  } finally {
    isProcessingRedirect = false;
  }
})();

const googleBtn = document.getElementById("googleLoginBtn");
const googleSpinner = document.getElementById("googleSpinner");

googleBtn.addEventListener("click", async () => {
  if (googleBtn.disabled) return;
  googleBtn.disabled = true;
  googleSpinner.classList.add('show');
  try {
    if (isIOS) {
      await signInWithRedirect(auth, provider);
    } else {
      const result = await signInWithPopup(auth, provider);
      console.log("Google User signed in:", result.user.email);
      showNotification("Welcome to Patholytica!", "success");
      closeLoginPopup();
      setTimeout(() => window.location.href = "dashboard.html", 1500);
    }
  } catch (error) {
    console.error("Google sign-in error:", error);
    let errorMessage = null;
    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage = 'Sign-in cancelled. Please try again.';
    } else if (error.code === 'auth/popup-blocked') {
      errorMessage = 'Popup blocked. Please allow popups for this site.';
    } else if (error.code === 'auth/cancelled-popup-request') {
      errorMessage = null;
    } else if (error.code === 'auth/account-exists-with-different-credential') {
      errorMessage = 'Account exists with different sign-in method.';
    } else {
      errorMessage = 'Google sign-in failed: ' + error.message;
    }
    if (errorMessage) showNotification(errorMessage, "error");
  } finally {
    if (!isIOS) {
      googleBtn.disabled = false;
      googleSpinner.classList.remove('show');
    }
  }
});

document.getElementById('emailLoginForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const loginSpinner = document.getElementById('loginSpinner');
  const submitBtn = document.getElementById('loginSubmitBtn');
  loginSpinner.classList.add('show');
  submitBtn.disabled = true;
  signInWithEmailAndPassword(auth, email, password)
    .then(() => {
      showNotification("Login successful! Redirecting...", "success");
      closeLoginPopup();
      setTimeout(() => window.location.href = "dashboard.html", 1500);
    })
    .catch(err => {
      console.error("Login error:", err);
      let errorMessage = "Login failed. ";
      switch (err.code) {
        case 'auth/invalid-email':
          errorMessage += "Invalid email address.";
          break;
        case 'auth/user-disabled':
          errorMessage += "This account has been disabled.";
          break;
        case 'auth/user-not-found':
          errorMessage += "No account found with this email.";
          break;
        case 'auth/wrong-password':
        case 'auth/invalid-credential':
          errorMessage += "Incorrect email or password.";
          break;
        case 'auth/too-many-requests':
          errorMessage += "Too many attempts. Try again later.";
          break;
        default:
          errorMessage += err.message;
      }
      showNotification(errorMessage, "error");
    })
    .finally(() => {
      loginSpinner.classList.remove('show');
      submitBtn.disabled = false;
    });
});

document.getElementById('signupForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const username = document.getElementById('signupUsername').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirm').value;
  const termsChecked = document.getElementById('termsCheckbox').checked;
  const signupSpinner = document.getElementById('signupSpinner');
  const submitBtn = document.getElementById('signupSubmitBtn');
  if (!termsChecked) {
    showNotification("Please agree to the Terms and Privacy Policy", "warning");
    return;
  }
  if (password !== confirmPassword) {
    showNotification("Passwords do not match.", "error");
    return;
  }
  if (password.length < 8) {
    showNotification("Password must be at least 8 characters.", "error");
    return;
  }
  signupSpinner.classList.add('show');
  submitBtn.disabled = true;
  createUserWithEmailAndPassword(auth, email, password)
    .then(() => {
      showNotification("Account created successfully! Redirecting...", "success");
      closeLoginPopup();
      setTimeout(() => window.location.href = "dashboard.html", 1500);
    })
    .catch(err => {
      console.error("Signup error:", err);
      let errorMessage = "Signup failed. ";
      switch (err.code) {
        case 'auth/email-already-in-use':
          errorMessage += "Email is already registered.";
          break;
        case 'auth/invalid-email':
          errorMessage += "Invalid email address.";
          break;
        case 'auth/weak-password':
          errorMessage += "Password is too weak.";
          break;
        default:
          errorMessage += err.message;
      }
      showNotification(errorMessage, "error");
    })
    .finally(() => {
      signupSpinner.classList.remove('show');
      submitBtn.disabled = false;
    });
});

onAuthStateChanged(auth, (user) => {
  const loadingOverlay = document.getElementById('loadingOverlay');
  const userMenuContainer = document.getElementById('userMenuContainer');
  const loginButton = document.getElementById('loginButton');
  if (user) {
    console.log("User authenticated:", user.email);
    userMenuContainer.style.display = 'block';
    loginButton.style.display = 'none';
    const displayName = user.displayName || user.email.split('@')[0];
    const email = user.email;
    const userAvatar = document.getElementById('userAvatar');
    const initials = displayName.substring(0, 2).toUpperCase();
    userAvatar.textContent = initials;
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userEmail').textContent = email;
  } else {
    console.log("No user authenticated - showing login button");
    userMenuContainer.style.display = 'none';
    loginButton.style.display = 'flex';
  }
  if (loadingOverlay) {
    loadingOverlay.style.display = 'none';
  }
  renderLibraries();
}, (error) => {
  console.error("Auth error:", error);
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (loadingOverlay) {
    loadingOverlay.style.display = 'none';
  }
  document.getElementById('loginButton').style.display = 'flex';
  document.getElementById('userMenuContainer').style.display = 'none';
  renderLibraries();
});

window.handleLogout = function() {
  signOut(auth)
    .then(() => {
      showNotification("Signed out successfully", "success");
      setTimeout(() => window.location.reload(), 1000);
    })
    .catch((error) => {
      console.error("Logout error:", error);
      showNotification("Error signing out: " + error.message, "error");
    });
};

window.toggleTheme = function(){
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
};

if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light-theme");
}

window.toggleUserMenu = function() {
  const dropdown = document.getElementById('userDropdown');
  dropdown.classList.toggle('show');
};

document.addEventListener('click', (e) => {
  const userMenu = document.querySelector('.user-menu');
  const dropdown = document.getElementById('userDropdown');
  if (userMenu && !userMenu.contains(e.target) && dropdown.classList.contains('show')) {
    dropdown.classList.remove('show');
  }
});

const libraries = {
  latest: [
    {
      id: 1,
      title: "Cardiovascular Pathology Database",
      author: "Dr. Sarah Mitchell",
      authorInitials: "SM",
      date: "2 days ago",
      datasets: 248,
      views: 1203,
      thumbnail: "https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=800&h=600&fit=crop"
    },
    {
      id: 2,
      title: "Neurological Disorders Repository",
      author: "Dr. James Chen",
      authorInitials: "JC",
      date: "5 days ago",
      datasets: 312,
      views: 892,
      thumbnail: "https://images.unsplash.com/photo-1559757175-5700dde675bc?w=800&h=600&fit=crop"
    },
    {
      id: 3,
      title: "Oncology Research Collection",
      author: "Dr. Emily Rodriguez",
      authorInitials: "ER",
      date: "1 week ago",
      datasets: 437,
      views: 1567,
      thumbnail: "https://images.unsplash.com/photo-1532187863486-abf9dbad1b69?w=800&h=600&fit=crop"
    },
    {
      id: 4,
      title: "Infectious Disease Archive",
      author: "Dr. Michael Park",
      authorInitials: "MP",
      date: "1 week ago",
      datasets: 195,
      views: 743,
      thumbnail: "https://images.unsplash.com/photo-1584036561566-baf8f5f1b144?w=800&h=600&fit=crop"
    }
  ],
  popular: [
    {
      id: 5,
      title: "Clinical Pathology Atlas",
      author: "Dr. Lisa Anderson",
      authorInitials: "LA",
      date: "3 months ago",
      datasets: 892,
      views: 15234,
      thumbnail: "https://images.unsplash.com/photo-1581093458791-9d42e1b7f1f9?w=800&h=600&fit=crop"
    },
    {
      id: 6,
      title: "Pediatric Disease Database",
      author: "Dr. Robert Kim",
      authorInitials: "RK",
      date: "2 months ago",
      datasets: 524,
      views: 12891,
      thumbnail: "https://images.unsplash.com/photo-1631217868264-e5b90bb7e133?w=800&h=600&fit=crop"
    },
    {
      id: 7,
      title: "Gastrointestinal Pathology Hub",
      author: "Dr. Maria Santos",
      authorInitials: "MS",
      date: "4 months ago",
      datasets: 651,
      views: 11456,
      thumbnail: "https://images.unsplash.com/photo-1579154204601-01588f351e67?w=800&h=600&fit=crop"
    },
    {
      id: 8,
      title: "Dermatopathology Library",
      author: "Dr. David Thompson",
      authorInitials: "DT",
      date: "5 months ago",
      datasets: 389,
      views: 9823,
      thumbnail: "https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=800&h=600&fit=crop"
    }
  ]
};

function createLibraryCard(library) {
  return `
    <a href="library.html?id=${library.id}" class="library-card">
      <div class="library-thumbnail-wrapper">
        <img src="${library.thumbnail}" alt="${library.title}" class="library-thumbnail" />
        <div class="library-duration">${library.datasets} datasets</div>
      </div>
      <div class="library-content">
        <div class="library-header">
          <div class="author-avatar">${library.authorInitials}</div>
          <div class="library-info">
            <h3 class="library-title">${library.title}</h3>
            <div class="library-meta">
              <span class="meta-item">${library.author}</span>
              <span class="meta-separator"></span>
              <span class="meta-item">${library.views.toLocaleString()} views</span>
              <span class="meta-separator"></span>
              <span class="meta-item">${library.date}</span>
            </div>
          </div>
        </div>
      </div>
    </a>
  `;
}

function renderLibraries() {
  const latestContainer = document.getElementById('latestLibraries');
  const popularContainer = document.getElementById('popularLibraries');
  if (latestContainer && popularContainer) {
    latestContainer.innerHTML = libraries.latest.map(lib => createLibraryCard(lib)).join('');
    popularContainer.innerHTML = libraries.popular.map(lib => createLibraryCard(lib)).join('');
  }
}

const searchInput = document.getElementById('searchInput');
if (searchInput) {
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    if (searchTerm === '') {
      renderLibraries();
      return;
    }
    const allLibraries = [...libraries.latest, ...libraries.popular];
    const filtered = allLibraries.filter(lib => 
      lib.title.toLowerCase().includes(searchTerm) ||
      lib.author.toLowerCase().includes(searchTerm)
    );
    const latestContainer = document.getElementById('latestLibraries');
    const popularContainer = document.getElementById('popularLibraries');
    if (filtered.length === 0) {
      latestContainer.innerHTML = `
        <div class="empty-state" style="grid-column: 1/-1;">
          <i class="fas fa-search"></i>
          <p>No libraries found matching "${searchTerm}"</p>
        </div>
      `;
      popularContainer.innerHTML = '';
    } else {
      latestContainer.innerHTML = filtered.map(lib => createLibraryCard(lib)).join('');
      popularContainer.innerHTML = '';
    }
  });
}
</script>
</body>
</html>
