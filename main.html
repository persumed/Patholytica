<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Feed ‚Äî Patholytica</title>
<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --card-bg: rgba(24,24,24,0.9);
  --card-border: rgba(255,255,255,0.07);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

body.light-theme {
‚Äìbg-color: #f5f5f5;
‚Äìtext-color: #111;
‚Äìcard-bg: rgba(255,255,255,0.9);
‚Äìcard-border: rgba(0,0,0,0.1);
}

- { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, ‚ÄúSegoe UI‚Äù, Arial, sans-serif; }

body {
background: var(‚Äìbg-color);
color: var(‚Äìtext-color);
transition: background 0.3s ease, color 0.3s ease;
padding-bottom: 80px;
}

/* Header */
.header-wrapper {
position: fixed;
top: 0;
left: 0;
right: 0;
background: var(‚Äìbg-color);
border-bottom: 1px solid var(‚Äìcard-border);
z-index: 100;
transition: transform 0.3s ease;
}

.header-wrapper.hidden {
transform: translateY(-100%);
}

.header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 12px 20px;
max-width: 700px;
margin: 0 auto;
}

.logo {
font-size: 22px;
font-weight: 700;
color: var(‚Äìaccent);
text-decoration: none;
}

.theme-toggle {
padding: 8px 16px;
font-size: 13px;
background: var(‚Äìcard-bg);
border-radius: 8px;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
cursor: pointer;
transition: 0.2s ease;
font-weight: 500;
}

.theme-toggle:hover {
border-color: var(‚Äìaccent);
background: var(‚Äìaccent);
color: #fff;
}

/* Feed */
.feed-container {
max-width: 700px;
margin: 0 auto;
padding-top: 65px;
}

.post {
margin-bottom: 24px;
background: var(‚Äìcard-bg);
border: 1px solid var(‚Äìcard-border);
border-radius: 12px;
overflow: hidden;
animation: slideUp 0.3s ease;
}

@keyframes slideUp {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.post-header {
display: flex;
align-items: center;
gap: 12px;
padding: 16px 18px;
border-bottom: 1px solid var(‚Äìcard-border);
}

.post-avatar {
width: 44px;
height: 44px;
border-radius: 50%;
object-fit: cover;
border: 2px solid var(‚Äìcard-border);
background: var(‚Äìcard-bg);
}

.post-author-info {
flex: 1;
}

.post-author-name {
font-weight: 600;
font-size: 15px;
display: block;
margin-bottom: 2px;
}

.post-author-username {
font-size: 13px;
color: #888;
}

.post-time {
font-size: 12px;
color: #888;
}

/* Content */
.post-content {
padding: 18px;
}

.post-text {
font-size: 15px;
line-height: 1.6;
margin-bottom: 14px;
white-space: pre-wrap;
word-wrap: break-word;
}

.post-image {
width: 100%;
height: auto;
display: block;
border-radius: 8px;
margin-top: 12px;
}

/* Actions */
.post-actions {
display: flex;
gap: 8px;
padding: 12px 18px;
border-top: 1px solid var(‚Äìcard-border);
}

.action-btn {
display: flex;
align-items: center;
gap: 6px;
background: none;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
cursor: pointer;
font-size: 14px;
transition: 0.2s ease;
padding: 8px 16px;
border-radius: 20px;
font-weight: 500;
}

.action-btn:hover {
background: rgba(176, 0, 58, 0.1);
border-color: var(‚Äìaccent);
color: var(‚Äìaccent);
}

.action-btn.liked {
background: rgba(176, 0, 58, 0.15);
border-color: var(‚Äìaccent);
color: var(‚Äìaccent);
}

/* Comments */
.comments-section {
padding: 16px 18px;
border-top: 1px solid var(‚Äìcard-border);
background: rgba(0,0,0,0.2);
}

body.light-theme .comments-section {
background: rgba(0,0,0,0.03);
}

.comments-section.hidden {
display: none;
}

.comment {
margin-bottom: 14px;
padding-bottom: 14px;
border-bottom: 1px solid var(‚Äìcard-border);
}

.comment:last-of-type {
border-bottom: none;
margin-bottom: 8px;
}

.comment-header {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 8px;
}

.comment-avatar {
width: 32px;
height: 32px;
border-radius: 50%;
object-fit: cover;
background: var(‚Äìcard-bg);
}

.comment-author {
font-weight: 600;
font-size: 14px;
}

.comment-text {
font-size: 14px;
line-height: 1.5;
padding-left: 42px;
}

.comment-input-wrapper {
display: flex;
gap: 8px;
margin-top: 12px;
}

.comment-input {
flex: 1;
padding: 10px 14px;
border-radius: 20px;
border: 1px solid var(‚Äìcard-border);
background: var(‚Äìbg-color);
color: var(‚Äìtext-color);
font-size: 14px;
font-family: inherit;
}

.comment-input:focus {
outline: none;
border-color: var(‚Äìaccent);
}

.comment-submit {
padding: 10px 20px;
background: var(‚Äìaccent);
color: #fff;
border: none;
border-radius: 20px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: 0.2s ease;
}

.comment-submit:hover {
background: var(‚Äìaccent-hover);
}

/* Bottom Nav */
.bottom-nav {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: var(‚Äìbg-color);
border-top: 1px solid var(‚Äìcard-border);
padding: 12px;
z-index: 100;
display: flex;
justify-content: center;
gap: 12px;
box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
display: flex;
align-items: center;
gap: 8px;
padding: 12px 24px;
background: var(‚Äìcard-bg);
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
border-radius: 12px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: 0.2s ease;
text-decoration: none;
}

.nav-btn:hover {
border-color: var(‚Äìaccent);
transform: translateY(-2px);
}

.nav-btn.primary {
background: var(‚Äìaccent);
color: #fff;
border-color: var(‚Äìaccent);
}

.nav-btn.primary:hover {
background: var(‚Äìaccent-hover);
}

/* States */
.loading, .empty-state, .error-state {
text-align: center;
padding: 80px 20px;
color: #888;
}

.empty-state h2, .error-state h2 {
font-size: 24px;
margin-bottom: 8px;
color: var(‚Äìtext-color);
}

/* Modal */
.modal {
position: fixed;
inset: 0;
background: rgba(0, 0, 0, 0.85);
z-index: 200;
display: none;
align-items: center;
justify-content: center;
padding: 20px;
}

.modal.active {
display: flex;
}

.modal-content {
background: var(‚Äìcard-bg);
backdrop-filter: blur(20px);
border-radius: 16px;
border: 1px solid var(‚Äìcard-border);
padding: 28px;
max-width: 550px;
width: 100%;
box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-header h2 {
font-size: 20px;
}

.modal-close {
background: none;
border: none;
color: var(‚Äìtext-color);
font-size: 32px;
cursor: pointer;
line-height: 1;
width: 36px;
height: 36px;
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px;
transition: 0.2s;
}

.modal-close:hover {
background: rgba(255,255,255,0.1);
}

.modal-textarea {
width: 100%;
min-height: 120px;
padding: 14px;
border-radius: 10px;
border: 1px solid var(‚Äìcard-border);
background: var(‚Äìbg-color);
color: var(‚Äìtext-color);
font-size: 15px;
resize: vertical;
margin-bottom: 16px;
font-family: inherit;
}

.modal-textarea:focus {
outline: none;
border-color: var(‚Äìaccent);
}

.image-upload-btn {
display: inline-flex;
align-items: center;
gap: 8px;
padding: 10px 18px;
background: var(‚Äìbg-color);
border: 1px solid var(‚Äìcard-border);
border-radius: 8px;
cursor: pointer;
transition: 0.2s ease;
font-size: 14px;
color: var(‚Äìtext-color);
margin-bottom: 16px;
}

.image-upload-btn:hover {
border-color: var(‚Äìaccent);
}

.image-preview {
max-width: 100%;
border-radius: 10px;
display: none;
margin-bottom: 16px;
border: 1px solid var(‚Äìcard-border);
}

.modal-actions {
display: flex;
gap: 10px;
justify-content: flex-end;
}

.modal-btn {
padding: 12px 28px;
border-radius: 10px;
border: none;
cursor: pointer;
font-size: 15px;
font-weight: 600;
transition: 0.2s ease;
}

.modal-btn.cancel {
background: transparent;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
}

.modal-btn.cancel:hover {
background: rgba(255,255,255,0.05);
}

.modal-btn.submit {
background: var(‚Äìaccent);
color: #fff;
}

.modal-btn.submit:hover {
background: var(‚Äìaccent-hover);
}

.modal-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

@media (max-width: 640px) {
.feed-container {
padding-left: 12px;
padding-right: 12px;
}
.nav-btn span:last-child {
display: none;
}
}
</style>

</head>
<body>

<div class="header-wrapper" id="header">
  <div class="header">
    <a href="#" class="logo">Patholytica</a>
    <button class="theme-toggle" id="themeBtn">üåô Dark</button>
  </div>
</div>

<div class="feed-container">
  <div id="feedContent" class="loading">Loading feed...</div>
</div>

<div class="bottom-nav">
  <a href="#" class="nav-btn">
    <span>üè†</span>
    <span>Home</span>
  </a>
  <button class="nav-btn primary" id="createBtn">
    <span>‚úèÔ∏è</span>
    <span>Create</span>
  </button>
  <a href="#" class="nav-btn">
    <span>üë§</span>
    <span>Profile</span>
  </a>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Post</h2>
      <button class="modal-close" id="closeBtn">&times;</button>
    </div>
    <form id="postForm">
      <textarea id="postText" class="modal-textarea" placeholder="What's on your mind?" maxlength="2000"></textarea>

  <label class="image-upload-btn" for="postImg">
    <span>üì∑</span>
    <span>Add Image</span>
  </label>
  <input type="file" id="postImg" accept="image/*" style="display:none;">
  <img id="imgPreview" class="image-preview" alt="Preview">

  <div class="modal-actions">
    <button type="button" class="modal-btn cancel" id="cancelBtn">Cancel</button>
    <button type="submit" class="modal-btn submit" id="submitBtn">Post</button>
  </div>
</form>

  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const supabase = createClient(
  'https://vmgenqvsmqiphcajaclx.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZ2VucXZzbXFpcGhjYWphY2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTUzNzUsImV4cCI6MjA3OTI5MTM3NX0.a2FCNa6BzYqXJWPUkByxK1EiNzt1cZhc3cp2SVj-Ke4'
);

let currentUser = null;
let userLikes = new Set();

// Theme
const themeBtn = document.getElementById('themeBtn');
themeBtn.addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light-theme');
  themeBtn.textContent = isLight ? '‚òÄÔ∏è Light' : 'üåô Dark';
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
});

if (localStorage.getItem('theme') === 'light') {
  document.body.classList.add('light-theme');
  themeBtn.textContent = '‚òÄÔ∏è Light';
}

// Header scroll
let lastScroll = 0;
window.addEventListener('scroll', () => {
  const scroll = window.pageYOffset;
  document.getElementById('header').classList.toggle('hidden', scroll > lastScroll && scroll > 100);
  lastScroll = scroll;
});

// Modal
const modal = document.getElementById('modal');
const createBtn = document.getElementById('createBtn');
const closeBtn = document.getElementById('closeBtn');
const cancelBtn = document.getElementById('cancelBtn');
const postForm = document.getElementById('postForm');
const postImg = document.getElementById('postImg');
const imgPreview = document.getElementById('imgPreview');

createBtn.onclick = () => modal.classList.add('active');
closeBtn.onclick = cancelBtn.onclick = () => {
  modal.classList.remove('active');
  postForm.reset();
  imgPreview.style.display = 'none';
};

postImg.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5242880) {
    alert('Image must be under 5MB');
    postImg.value = '';
    return;
  }
  imgPreview.src = URL.createObjectURL(file);
  imgPreview.style.display = 'block';
};

// Utils
const esc = (str) => {
  const el = document.createElement('div');
  el.textContent = str;
  return el.innerHTML;
};

const timeAgo = (date) => {
  const sec = Math.floor((Date.now() - new Date(date)) / 1000);
  if (sec < 60) return 'now';
  if (sec < 3600) return Math.floor(sec / 60) + 'm';
  if (sec < 86400) return Math.floor(sec / 3600) + 'h';
  if (sec < 604800) return Math.floor(sec / 86400) + 'd';
  return new Date(date).toLocaleDateString();
};

// Load likes
async function loadLikes() {
  if (!currentUser) return;
  try {
    const { data } = await supabase
      .from('post_likes')
      .select('post_id')
      .eq('firebase_uid', currentUser.uid);
    userLikes = new Set(data?.map(l => l.post_id) || []);
  } catch (err) {
    console.error('Load likes error:', err);
  }
}

// Load feed
async function loadFeed() {
  const feed = document.getElementById('feedContent');
  try {
    const { data, error } = await supabase
      .from('posts')
      .select('*, users(name, username, profile_pic)')
      .order('created_at', { ascending: false })
      .limit(30);
    
    if (error) throw error;
    
    if (!data?.length) {
      feed.innerHTML = '<div class="empty-state"><h2>No posts yet</h2><p>Be the first to share!</p></div>';
      return;
    }
    
    feed.innerHTML = data.map(renderPost).join('');
  } catch (err) {
    console.error('Feed error:', err);
    feed.innerHTML = `<div class="error-state"><h2>Error</h2><p>${err.message}</p></div>`;
  }
}

// Render post
function renderPost(p) {
  const u = p.users || {};
  const liked = userLikes.has(p.id);
  return `
    <div class="post" data-id="${p.id}">
      <div class="post-header">
        <img src="${u.profile_pic || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name || 'User')}" class="post-avatar" alt="${u.name}">
        <div class="post-author-info">
          <span class="post-author-name">${esc(u.name || 'Anonymous')}</span>
          <span class="post-author-username">@${esc(u.username || 'user')}</span>
        </div>
        <span class="post-time">${timeAgo(p.created_at)}</span>
      </div>
      ${p.content || p.image_url ? `<div class="post-content">
        ${p.content ? `<div class="post-text">${esc(p.content)}</div>` : ''}
        ${p.image_url ? `<img src="${p.image_url}" class="post-image" alt="Post">` : ''}
      </div>` : ''}
      <div class="post-actions">
        <button class="action-btn ${liked ? 'liked' : ''}" onclick="like('${p.id}')">
          <span>${liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
          <span class="like-count">${p.likes_count || 0}</span>
        </button>
        <button class="action-btn" onclick="showComments('${p.id}')">
          <span>üí¨</span>
          <span>${p.comments_count || 0}</span>
        </button>
      </div>
      <div class="comments-section hidden" id="c-${p.id}">
        <div id="cl-${p.id}"></div>
        <div class="comment-input-wrapper">
          <input type="text" class="comment-input" placeholder="Add comment..." id="ci-${p.id}">
          <button class="comment-submit" onclick="addComment('${p.id}')">Post</button>
        </div>
      </div>
    </div>
  `;
}

// Like
window.like = async (id) => {
  if (!currentUser) return alert('Login required');
  const liked = userLikes.has(id);
  const post = document.querySelector(`[data-id="${id}"]`);
  const btn = post.querySelector('.action-btn');
  const count = post.querySelector('.like-count');
  
  try {
    if (liked) {
      await supabase.from('post_likes').delete().eq('post_id', id).eq('firebase_uid', currentUser.uid);
      userLikes.delete(id);
      btn.classList.remove('liked');
      btn.querySelector('span').textContent = 'ü§ç';
      count.textContent = +count.textContent - 1;
    } else {
      await supabase.from('post_likes').insert({ post_id: id, firebase_uid: currentUser.uid });
      userLikes.add(id);
      btn.classList.add('liked');
      btn.querySelector('span').textContent = '‚ù§Ô∏è';
      count.textContent = +count.textContent + 1;
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
};

// Comments
window.showComments = async (id) => {
  const sec = document.getElementById(`c-${id}`);
  const hidden = sec.classList.toggle('hidden');
  if (!hidden) await loadComments(id);
};

async function loadComments(id) {
  const list = document.getElementById(`cl-${id}`);
  try {
    const { data, error } = await supabase
      .from('post_comments')
      .select('*, users(name, profile_pic)')
      .eq('post_id', id)
      .order('created_at', { ascending: true });
    
    if (error) throw error;
    
    if (!data?.length) {
      list.innerHTML = '<p style="text-align:center;color:#888;padding:16px">No comments yet</p>';
      return;
    }
    
    list.innerHTML = data.map(c => {
      const u = c.users || {};
      return `
        <div class="comment">
          <div class="comment-header">
            <img src="${u.profile_pic || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name || 'User')}" class="comment-avatar" alt="${u.name}">
            <span class="comment-author">${esc(u.name || 'User')}</span>
          </div>
          <div class="comment-text">${esc(c.comment_text)}</div>
        </div>
      `;
    }).join('');
  } catch (err) {
    list.innerHTML = '<p style="color:#888">Error loading comments</p>';
  }
}

window.addComment = async (id) => {
  if (!currentUser) return alert('Login required');
  const input = document.getElementById(`ci-${id}`);
  const text = input.value.trim();
  if (!text) return;
  
  try {
    await supabase.from('post_comments').insert({
      post_id: id,
      firebase_uid: currentUser.uid,
      comment_text: text
    });
    input.value = '';
    await loadComments(id);
    
    const post = document.querySelector(`[data-id="${id}"]`);
    const commentCount = post.querySelector('.action-btn:nth-child(2) span:last-child');
    commentCount.textContent = +commentCount.textContent + 1;
  } catch (err) {
    alert('Error: ' + err.message);
  }
};

// Create post
postForm.onsubmit = async (e) => {
  e.preventDefault();
  if (!currentUser) return alert('Login required');
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Posting...';
  
  try {
    const content = document.getElementById('postText').value.trim();
    let imageUrl = null;
    
    if (postImg.files[0]) {
      const file = postImg.files[0];
      const path = `posts/${currentUser.uid}/${Date.now()}.${file.name.split('.').pop()}`;
      const { error: upErr } = await supabase.storage.from('profile-pictures').upload(path, file);
      if (upErr) throw upErr;
      const { data: urlData } = supabase.storage.from('profile-pictures').getPublicUrl(path);
      imageUrl = urlData.publicUrl;
    }
    
    if (!content && !imageUrl) {
      alert('Please add text or image');
      return;
    }
    
    await supabase.from('posts').insert({
      firebase_uid: currentUser.uid,
      content: content || null,
      image_url: imageUrl
    });
    
    modal.classList.remove('active');
    postForm.reset();
    imgPreview.style.display = 'none';
    await loadFeed();
  } catch (err) {
    alert('Error: ' + err.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Post';
  }
};

// Auth
onAuthStateChanged(auth, async (user) => {
  currentUser = user;
  if (!user) {
    document.getElementById('feedContent').innerHTML = '<div class="empty-state"><h2>Please log in</h2><p>Sign in to see posts</p></div>';
    return;
  }
  await loadLikes();
  await loadFeed();
});
</script>

</body>
</html>