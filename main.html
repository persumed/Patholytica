<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Feed ‚Äî Patholytica</title>
<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --card-bg: rgba(24,24,24,0.7);
  --card-border: rgba(255,255,255,0.07);
  --accent: #b0003a;
  --accent-hover: #88002a;
}

body.light-theme {
‚Äìbg-color: #f5f5f5;
‚Äìtext-color: #111;
‚Äìcard-bg: rgba(255,255,255,0.65);
‚Äìcard-border: rgba(0,0,0,0.1);
}

- { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; font-family: ‚ÄúInter‚Äù, Arial, sans-serif; }

body {
background: var(‚Äìbg-color);
color: var(‚Äìtext-color);
transition: background 0.35s ease;
padding-bottom: 70px;
}

.header-wrapper {
position: fixed;
top: 0;
left: 0;
right: 0;
background: var(‚Äìbg-color);
border-bottom: 1px solid var(‚Äìcard-border);
z-index: 100;
transition: transform 0.3s ease;
padding-top: env(safe-area-inset-top);
}

.header-wrapper.hidden {
transform: translateY(-100%);
}

.header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 16px 18px;
max-width: 800px;
margin: 0 auto;
}

.logo-img {
height: 32px;
width: auto;
cursor: pointer;
transition: filter 0.25s ease;
}

body.light-theme .logo-img { filter: invert(1); }

.theme-toggle {
padding: 6px 14px;
font-size: 12.5px;
background: transparent;
border-radius: 6px;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
cursor: pointer;
transition: 0.25s ease;
}

.theme-toggle:hover {
border-color: var(‚Äìaccent);
color: var(‚Äìaccent);
}

.feed-container {
max-width: 800px;
margin: 0 auto;
padding: calc(70px + env(safe-area-inset-top)) 0 0 0;
}

.post {
margin-bottom: 32px;
animation: fadeIn 0.4s ease;
}

.post-header {
display: flex;
align-items: center;
gap: 12px;
padding: 0 18px 12px;
}

.post-avatar {
width: 42px;
height: 42px;
border-radius: 50%;
object-fit: cover;
border: 2px solid var(‚Äìcard-border);
}

.post-author-info {
flex: 1;
}

.post-author-name {
font-weight: 600;
font-size: 15px;
display: block;
}

.post-author-username {
font-size: 13px;
color: #888;
}

.post-time {
font-size: 13px;
color: #888;
}

.post-content {
padding: 0 18px;
margin-bottom: 12px;
}

.post-text {
font-size: 15px;
line-height: 1.6;
margin-bottom: 12px;
white-space: pre-wrap;
word-wrap: break-word;
}

.post-image {
width: 100%;
height: auto;
display: block;
border-radius: 8px;
margin-top: 12px;
}

.post-actions {
display: flex;
gap: 24px;
padding: 12px 18px;
border-bottom: 1px solid var(‚Äìcard-border);
}

.action-btn {
display: flex;
align-items: center;
gap: 8px;
background: none;
border: none;
color: var(‚Äìtext-color);
cursor: pointer;
font-size: 14px;
transition: 0.2s ease;
padding: 6px 10px;
border-radius: 6px;
}

.action-btn:hover {
background: rgba(176, 0, 58, 0.1);
color: var(‚Äìaccent);
}

.action-btn.liked {
color: var(‚Äìaccent);
}

.comments-section {
padding: 16px 18px;
border-bottom: 1px solid var(‚Äìcard-border);
}

.comments-section.hidden {
display: none;
}

.comment {
margin-bottom: 16px;
padding-bottom: 12px;
border-bottom: 1px solid var(‚Äìcard-border);
}

.comment:last-child {
border-bottom: none;
margin-bottom: 0;
}

.comment-header {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 6px;
}

.comment-avatar {
width: 32px;
height: 32px;
border-radius: 50%;
object-fit: cover;
}

.comment-author {
font-weight: 600;
font-size: 14px;
}

.comment-text {
font-size: 14px;
line-height: 1.5;
margin-left: 42px;
}

.comment-input-wrapper {
display: flex;
gap: 10px;
margin-top: 12px;
}

.comment-input {
flex: 1;
padding: 10px 14px;
border-radius: 20px;
border: 1px solid var(‚Äìcard-border);
background: var(‚Äìcard-bg);
color: var(‚Äìtext-color);
font-size: 14px;
resize: none;
font-family: inherit;
}

.comment-input:focus {
outline: none;
border-color: var(‚Äìaccent);
}

.comment-submit {
padding: 8px 16px;
background: var(‚Äìaccent);
color: #fff;
border: none;
border-radius: 20px;
font-size: 14px;
cursor: pointer;
transition: 0.2s ease;
}

.comment-submit:hover {
background: var(‚Äìaccent-hover);
}

.bottom-nav {
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: var(‚Äìbg-color);
border-top: 1px solid var(‚Äìcard-border);
padding: 12px 18px;
padding-bottom: calc(12px + env(safe-area-inset-bottom));
z-index: 100;
display: flex;
justify-content: center;
gap: 16px;
}

.nav-btn {
display: flex;
align-items: center;
gap: 8px;
padding: 10px 20px;
background: transparent;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
border-radius: 8px;
cursor: pointer;
font-size: 14px;
transition: 0.2s ease;
}

.nav-btn:hover {
border-color: var(‚Äìaccent);
color: var(‚Äìaccent);
}

.nav-btn.primary {
background: var(‚Äìaccent);
color: #fff;
border-color: var(‚Äìaccent);
}

.nav-btn.primary:hover {
background: var(‚Äìaccent-hover);
}

.loading, .empty-state {
text-align: center;
padding: 60px 20px;
color: #888;
}

.modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.8);
z-index: 200;
display: none;
align-items: center;
justify-content: center;
padding: 20px;
}

.modal.active {
display: flex;
}

.modal-content {
background: var(‚Äìcard-bg);
backdrop-filter: blur(22px);
border-radius: 16px;
border: 1px solid var(‚Äìcard-border);
padding: 30px;
max-width: 600px;
width: 100%;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
}

.modal-close {
background: none;
border: none;
color: var(‚Äìtext-color);
font-size: 28px;
cursor: pointer;
}

.modal-textarea {
width: 100%;
min-height: 120px;
padding: 14px;
border-radius: 8px;
border: 1px solid var(‚Äìcard-border);
background: rgba(0, 0, 0, 0.25);
color: var(‚Äìtext-color);
font-size: 15px;
resize: vertical;
margin-bottom: 16px;
font-family: inherit;
}

body.light-theme .modal-textarea {
background: rgba(255, 255, 255, 0.7);
}

.modal-textarea:focus {
outline: none;
border-color: var(‚Äìaccent);
}

.image-upload-label {
display: inline-block;
padding: 10px 16px;
background: transparent;
border: 1px solid var(‚Äìcard-border);
border-radius: 8px;
cursor: pointer;
transition: 0.2s ease;
font-size: 14px;
margin-bottom: 16px;
}

.image-upload-label:hover {
border-color: var(‚Äìaccent);
}

.image-preview {
max-width: 100%;
border-radius: 8px;
display: none;
margin-bottom: 16px;
}

.modal-actions {
display: flex;
gap: 12px;
justify-content: flex-end;
}

.modal-btn {
padding: 12px 24px;
border-radius: 8px;
border: none;
cursor: pointer;
font-size: 15px;
transition: 0.2s ease;
}

.modal-btn.cancel {
background: transparent;
border: 1px solid var(‚Äìcard-border);
color: var(‚Äìtext-color);
}

.modal-btn.submit {
background: var(‚Äìaccent);
color: #fff;
}

.modal-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}
</style>

</head>
<body>

<div class="header-wrapper" id="header">
  <div class="header">
    <img src="https://via.placeholder.com/150x40/b0003a/ffffff?text=Patholytica" class="logo-img" alt="Logo">
    <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
  </div>
</div>

<div class="feed-container">
  <div id="feedContent" class="loading">Loading feed...</div>
</div>

<div class="bottom-nav">
  <button class="nav-btn">üè† Home</button>
  <button class="nav-btn primary" onclick="openModal()">‚úèÔ∏è Create Post</button>
  <button class="nav-btn">üë§ Profile</button>
</div>

<div class="modal" id="createPostModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create Post</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <form id="createPostForm">
      <textarea id="postContent" class="modal-textarea" placeholder="What's on your mind?"></textarea>


  <label class="image-upload-label" for="postImage">üì∑ Add Image</label>
  <input type="file" id="postImage" accept="image/*" style="display: none;">
  <img id="imagePreview" class="image-preview" alt="Preview">

  <div class="modal-actions">
    <button type="button" class="modal-btn cancel" onclick="closeModal()">Cancel</button>
    <button type="submit" class="modal-btn submit" id="submitBtn">Post</button>
  </div>
</form>


  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const SUPABASE_URL = 'https://vmgenqvsmqiphcajaclx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZ2VucXZzbXFpcGhjYWphY2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MTUzNzUsImV4cCI6MjA3OTI5MTM3NX0.a2FCNa6BzYqXJWPUkByxK1EiNzt1cZhc3cp2SVj-Ke4';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let userLikes = new Set();

function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
}
if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');
window.toggleTheme = toggleTheme;

let lastScroll = 0;
window.addEventListener('scroll', () => {
  const currentScroll = window.pageYOffset;
  const header = document.getElementById('header');
  if (currentScroll > lastScroll && currentScroll > 80) {
    header.classList.add('hidden');
  } else {
    header.classList.remove('hidden');
  }
  lastScroll = currentScroll;
});

window.openModal = () => document.getElementById('createPostModal').classList.add('active');
window.closeModal = () => {
  document.getElementById('createPostModal').classList.remove('active');
  document.getElementById('createPostForm').reset();
  document.getElementById('imagePreview').style.display = 'none';
};

document.getElementById('postImage').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) {
    alert('Image must be smaller than 5MB.');
    e.target.value = '';
    return;
  }
  const preview = document.getElementById('imagePreview');
  preview.src = URL.createObjectURL(file);
  preview.style.display = 'block';
});

function timeAgo(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
  if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
  return new Date(date).toLocaleDateString();
}

async function loadUserLikes() {
  if (!currentUser) return;
  const { data } = await supabase
    .from('post_likes')
    .select('post_id')
    .eq('firebase_uid', currentUser.uid);
  userLikes = new Set(data?.map(like => like.post_id) || []);
}

async function loadFeed() {
  const feedContent = document.getElementById('feedContent');
  try {
    const { data: posts, error } = await supabase
      .from('posts')
      .select(`*, users(name, username, profile_pic)`)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    if (!posts || posts.length === 0) {
      feedContent.innerHTML = '<div class="empty-state"><h2>No posts yet</h2><p>Be the first to share!</p></div>';
      return;
    }
    feedContent.innerHTML = posts.map(renderPost).join('');
  } catch (err) {
    feedContent.innerHTML = `<div class="empty-state"><h2>Error</h2><p>${err.message}</p></div>`;
  }
}

function renderPost(post) {
  const user = post.users;
  const isLiked = userLikes.has(post.id);
  return `
    <div class="post" data-id="${post.id}">
      <div class="post-header">
        <img src="${user?.profile_pic || 'https://via.placeholder.com/42'}" class="post-avatar" alt="${user?.name}">
        <div class="post-author-info">
          <span class="post-author-name">${user?.name || 'Anonymous'}</span>
          <span class="post-author-username">@${user?.username || 'user'}</span>
        </div>
        <span class="post-time">${timeAgo(post.created_at)}</span>
      </div>
      <div class="post-content">
        ${post.content ? `<div class="post-text">${escapeHtml(post.content)}</div>` : ''}
        ${post.image_url ? `<img src="${post.image_url}" class="post-image" alt="Post">` : ''}
      </div>
      <div class="post-actions">
        <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')">
          <span>${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
          <span class="like-count">${post.likes_count}</span>
        </button>
        <button class="action-btn" onclick="toggleComments('${post.id}')">
          <span>üí¨</span>
          <span>${post.comments_count}</span>
        </button>
      </div>
      <div class="comments-section hidden" id="comments-${post.id}">
        <div id="comments-list-${post.id}"></div>
        <div class="comment-input-wrapper">
          <textarea class="comment-input" placeholder="Comment..." rows="1" id="input-${post.id}"></textarea>


      <button class="comment-submit" onclick="submitComment('${post.id}')">Post</button>
    </div>
  </div>
</div>


`;
}

function escapeHtml(text) {
const div = document.createElement(‚Äòdiv‚Äô);
div.textContent = text;
return div.innerHTML;
}

window.toggleLike = async (postId) => {
if (!currentUser) return alert(‚ÄòPlease log in‚Äô);
const isLiked = userLikes.has(postId);
const postEl = document.querySelector(`[data-id="${postId}"]`);
const btn = postEl.querySelector(‚Äô.action-btn‚Äô);
const count = postEl.querySelector(‚Äô.like-count‚Äô);

try {
if (isLiked) {
await supabase.from(‚Äòpost_likes‚Äô).delete().eq(‚Äòpost_id‚Äô, postId).eq(‚Äòfirebase_uid‚Äô, currentUser.uid);
userLikes.delete(postId);
btn.classList.remove(‚Äòliked‚Äô);
btn.querySelector(‚Äòspan‚Äô).textContent = ‚Äòü§ç‚Äô;
count.textContent = parseInt(count.textContent) - 1;
} else {
await supabase.from(‚Äòpost_likes‚Äô).insert({ post_id: postId, firebase_uid: currentUser.uid });
userLikes.add(postId);
btn.classList.add(‚Äòliked‚Äô);
btn.querySelector(‚Äòspan‚Äô).textContent = ‚Äò‚ù§Ô∏è‚Äô;
count.textContent = parseInt(count.textContent) + 1;
}
} catch (err) {
alert(‚ÄôError: ‚Äô + err.message);
}
};

window.toggleComments = async (postId) => {
const section = document.getElementById(`comments-${postId}`);
const isHidden = section.classList.contains(‚Äòhidden‚Äô);
if (isHidden) {
section.classList.remove(‚Äòhidden‚Äô);
await loadComments(postId);
} else {
section.classList.add(‚Äòhidden‚Äô);
}
};

async function loadComments(postId) {
const list = document.getElementById(`comments-list-${postId}`);
try {
const { data, error } = await supabase
.from(‚Äòpost_comments‚Äô)
.select(`*, users(name, profile_pic)`)
.eq(‚Äòpost_id‚Äô, postId)
.order(‚Äòcreated_at‚Äô, { ascending: true });
if (error) throw error;
if (!data || data.length === 0) {
list.innerHTML = ‚Äò<p style="color:#888;text-align:center;padding:20px">No comments yet</p>‚Äô;
return;
}
list.innerHTML = data.map(c => `<div class="comment"> <div class="comment-header"> <img src="${c.users?.profile_pic || 'https://via.placeholder.com/32'}" class="comment-avatar" alt="${c.users?.name}"> <span class="comment-author">${c.users?.name || 'User'}</span> </div> <div class="comment-text">${escapeHtml(c.comment_text)}</div> </div>`).join(‚Äô‚Äô);
} catch (err) {
list.innerHTML = ‚Äò<p style="color:#888">Error loading comments</p>‚Äô;
}
}

window.submitComment = async (postId) => {
if (!currentUser) return alert(‚ÄòPlease log in‚Äô);
const input = document.getElementById(`input-${postId}`);
const text = input.value.trim();
if (!text) return;

try {
await supabase.from(‚Äòpost_comments‚Äô).insert({
post_id: postId,
firebase_uid: currentUser.uid,
comment_text: text
});
input.value = ‚Äò‚Äô;
await loadComments(postId);
} catch (err) {
alert(‚ÄôError: ‚Äô + err.message);
}
};

async function uploadImage(file) {
const ext = file.name.split(‚Äô.‚Äô).pop();
const path = `posts/${currentUser.uid}/${Date.now()}.${ext}`;
const { error } = await supabase.storage.from(‚Äòprofile-pictures‚Äô).upload(path, file);
if (error) throw error;
const { data } = supabase.storage.from(‚Äòprofile-pictures‚Äô).getPublicUrl(path);
return data.publicUrl;
}

document.getElementById(‚ÄòcreatePostForm‚Äô).addEventListener(‚Äòsubmit‚Äô, async (e) => {
e.preventDefault();
if (!currentUser) return alert(‚ÄòPlease log in‚Äô);

const btn = document.getElementById(‚ÄòsubmitBtn‚Äô);
btn.disabled = true;
btn.textContent = ‚ÄòPosting‚Ä¶‚Äô;

try {
const content = document.getElementById(‚ÄòpostContent‚Äô).value.trim();
const fileInput = document.getElementById(‚ÄòpostImage‚Äô);
let imageUrl = null;


if (fileInput.files[0]) {
  imageUrl = await uploadImage(fileInput.files[0]);
}

if (!content && !imageUrl) {
  alert('Please add text or image');
  return;
}

await supabase.from('posts').insert({
  firebase_uid: currentUser.uid,
  content: content || null,
  image_url: imageUrl
});

closeModal();
await loadFeed();


} catch (err) {
alert(‚ÄôError: ‚Äô + err.message);
} finally {
btn.disabled = false;
btn.textContent = ‚ÄòPost‚Äô;
}
});

onAuthStateChanged(auth, async (user) => {
currentUser = user;
if (!user) {
document.getElementById(‚ÄòfeedContent‚Äô).innerHTML = ‚Äò<div class="empty-state"><h2>Please log in</h2></div>‚Äô;
return;
}
await loadUserLikes();
await loadFeed();
});
</script>

</body>
</html>