<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — Profile</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg-color: #0f0f0f;
  --text-primary: #fff;
  --text-secondary: #aaa;
  --hover-bg: #2a2a2a;
  --border-color: #303030;
  --accent: #3ea6ff;
  --card-bg: #1f1f1f;
  --error-color: #ff4444;
  --loading-color: #666;
}
body.light-theme {
  --bg-color: #ffffff;
  --text-primary: #0f0f0f;
  --text-secondary: #606060;
  --hover-bg: #f0f0f0;
  --border-color: #e5e5e5;
  --accent: #065fd4;
  --card-bg: #f9f9f9;
  --error-color: #cc0000;
  --loading-color: #999;
}
* { box-sizing: border-box; }
html, body { 
  margin: 0; 
  padding: 0; 
  min-height: 100%; 
  font-family: "Roboto", Arial, sans-serif;
  overflow-x: hidden;
  max-width: 100vw;
}
body {
  background: var(--bg-color);
  color: var(--text-primary);
  transition: background 0.2s ease, color 0.2s ease;
}
.header-wrapper {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--border-color);
  z-index: 40;
  width: 100%;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  max-width: 100%;
  margin: 0 auto;
}
.logo-img {
  height: 28px;
  width: auto;
  transition: filter 0.2s ease;
  cursor: pointer;
}
body.light-theme .logo-img {
  filter: invert(1);
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}
.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: transparent;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: background 0.2s ease;
}
.icon-btn:hover {
  background: var(--hover-bg);
}
.profile-container {
  max-width: 900px;
  width: 100%;
  margin: 0 auto;
  padding: 80px 24px 80px;
  padding-top: calc(70px + env(safe-area-inset-top));
}
.loading-state, .error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-secondary);
}
.error-state {
  color: var(--error-color);
}
.error-state button {
  margin-top: 16px;
  padding: 10px 20px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
}
.profile-header {
  display: flex;
  align-items: center;
  gap: 24px;
  margin-bottom: 32px;
  padding-bottom: 32px;
  border-bottom: 1px solid var(--border-color);
}
.profile-photo {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}
.profile-info {
  flex: 1;
}
.profile-name {
  font-size: 28px;
  font-weight: 600;
  margin: 0 0 16px 0;
}
.profile-stats {
  display: flex;
  flex-direction: column;
  gap: 12px;
  font-size: 14px;
  color: var(--text-secondary);
}
.stats-row {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}
.stat-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.stat-value {
  color: var(--text-primary);
  font-weight: 500;
}
.badge-icon {
  font-size: 12px;
}
.badge-icon.bronze { color: #cd7f32; }
.badge-icon.gold { color: #ffd700; }
.badge-icon.platinum { color: #e5e4e2; }
.tabs {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
  border-bottom: 1px solid var(--border-color);
}
.tab-btn {
  padding: 12px 0;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  position: relative;
  transition: color 0.2s ease;
}
.tab-btn:hover {
  color: var(--text-primary);
}
.tab-btn.active {
  color: var(--text-primary);
}
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--accent);
}
.tab-count {
  margin-left: 6px;
  color: var(--text-secondary);
  font-size: 14px;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.article-list, .library-list, .comments-list {
  list-style: none;
  margin: 0;
  padding: 0;
}
.article-item, .library-item, .comment-item {
  padding: 24px 0;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
  transition: background 0.2s ease;
  opacity: 0;
  animation: fadeInUp 0.3s ease forwards;
}
.article-item:hover, .library-item:hover {
  background: var(--hover-bg);
  margin: 0 -12px;
  padding: 24px 12px;
}
.article-title {
  font-family: 'Times New Roman', Times, serif;
  font-size: 24px;
  font-weight: bold;
  margin: 0 0 8px 0;
  line-height: 1.3;
  color: var(--text-primary);
  word-wrap: break-word;
}
.article-item:hover .article-title {
  color: var(--accent);
}
.article-meta, .library-meta {
  font-size: 14px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.meta-dot {
  width: 3px;
  height: 3px;
  background: var(--text-secondary);
  border-radius: 50%;
}
.library-title {
  font-size: 20px;
  font-weight: 600;
  margin: 0 0 8px 0;
  color: var(--text-primary);
}
.library-item:hover .library-title {
  color: var(--accent);
}
.comment-article {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.comment-text {
  font-size: 15px;
  color: var(--text-primary);
  margin-bottom: 8px;
  line-height: 1.5;
}
.comment-meta {
  font-size: 13px;
  color: var(--text-secondary);
}
.profile-footer {
  margin-top: 60px;
  padding-top: 32px;
}
.bio-section, .email-section {
  margin-bottom: 24px;
}
.bio-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.bio-text {
  font-size: 15px;
  line-height: 1.6;
  color: var(--text-primary);
}
.email-text {
  font-size: 14px;
  color: var(--accent);
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@media (max-width: 768px) {
  .profile-container {
    padding: 90px 16px 80px;
  }
  .profile-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .profile-name {
    font-size: 24px;
  }
  .article-title {
    font-size: 20px;
  }
  .tabs {
    gap: 20px;
    overflow-x: auto;
  }
}
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo" onclick="goHome()">
    <div class="header-actions">
      <button class="icon-btn" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-circle-half-stroke"></i>
      </button>
      <button class="icon-btn" title="User">
        <i class="fas fa-user"></i>
      </button>
    </div>
  </div>
</div>

<div class="profile-container">
  <div id="loadingState" class="loading-state">
    <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 16px;"></i>
    <p>Loading profile...</p>
  </div>
  
  <div id="errorState" class="error-state" style="display: none;">
    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 16px;"></i>
    <p>Failed to load profile. Please try again.</p>
    <button onclick="loadProfile()">Retry</button>
  </div>
  
  <div id="profileContent" style="display: none;">
    <div class="profile-header">
      <img src="" alt="Profile Photo" class="profile-photo" id="profilePhoto">
      <div class="profile-info">
        <h1 class="profile-name" id="profileName">Loading...</h1>
        <div class="profile-stats">
          <div class="stats-row">
            <div class="stat-item">
              <i class="fas fa-medal badge-icon bronze"></i>
              <span class="stat-value" id="bronzeBadges">0</span>
              <span>Bronze</span>
            </div>
            <div class="stat-item">
              <i class="fas fa-medal badge-icon gold"></i>
              <span class="stat-value" id="goldBadges">0</span>
              <span>Gold</span>
            </div>
            <div class="stat-item">
              <i class="fas fa-medal badge-icon platinum"></i>
              <span class="stat-value" id="platinumBadges">0</span>
              <span>Platinum</span>
            </div>
          </div>
          <div class="stats-row">
            <div class="stat-item">
              <i class="fas fa-users"></i>
              <span class="stat-value" id="followersCount">0</span>
              <span>Followers</span>
            </div>
            <div class="stat-item">
              <i class="fas fa-user-plus"></i>
              <span class="stat-value" id="followingCount">0</span>
              <span>Following</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('articles')">
        Articles<span class="tab-count" id="articlesCount">(0)</span>
      </button>
      <button class="tab-btn" onclick="switchTab('libraries')">
        Libraries<span class="tab-count" id="librariesCount">(0)</span>
      </button>
      <button class="tab-btn" onclick="switchTab('comments')">
        Comments<span class="tab-count" id="commentsCount">(0)</span>
      </button>
    </div>

    <div class="tab-content active" id="articles-tab">
      <ul class="article-list" id="articlesList">
        <!-- Articles will be populated here -->
      </ul>
    </div>

    <div class="tab-content" id="libraries-tab">
      <ul class="library-list" id="librariesList">
        <!-- Libraries will be populated here -->
      </ul>
    </div>

    <div class="tab-content" id="comments-tab">
      <div class="comments-list" id="commentsList">
        <!-- Comments will be populated here -->
      </div>
    </div>

    <div class="profile-footer">
      <div class="bio-section">
        <div class="bio-label">Bio</div>
        <div class="bio-text" id="bioText">
          Loading biography...
        </div>
      </div>
      <div class="email-section">
        <div class="bio-label">Contact</div>
        <div class="email-text" id="emailText">
          Loading email...
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Supabase configuration
const SUPABASE_URL = 'https://raaylemyoajafvufkldf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhYXlsZW15b2FqYWZ2dWZrbGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMjE0MDAsImV4cCI6MjA4MjU5NzQwMH0.8qHi4IPItPZEXAzD3nL_M5PBDfADAk-XntODwYZyaG8';

// Initialize Supabase client
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global variables
let currentUser = null;
let currentUserId = null;

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  loadTheme();
  loadProfile();
});

// Theme management
function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}

function loadTheme() {
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light-theme");
  }
}

// Profile loading and display
async function loadProfile() {
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('id') || 'test-user'; // Default to test user
  
  currentUserId = userId;
  showLoadingState();
  
  try {
    // For demonstration, we'll use a default user profile
    // In a real app, this would fetch from the database
    if (userId === 'test-user') {
      // Create mock user data
      currentUser = {
        id: 'test-user',
        full_name: 'Dr. Sarah Mitchell',
        display_name: 'Dr. Sarah Mitchell',
        email: 'sarah.mitchell@jhmi.edu',
        bio: 'Cardiovascular pathologist and researcher specializing in advanced diagnostic techniques. Associate Professor at Johns Hopkins Medicine with over 15 years of experience in cardiac imaging and molecular pathology. Passionate about medical education and advancing the field of cardiovascular research.',
        profile_photo_url: 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=200&h=200&fit=crop',
        specialty: 'Cardiovascular Pathology',
        institution: 'Johns Hopkins Medicine',
        user_stats: {
          followers_count: 12400,
          following_count: 1823,
          articles_count: 47,
          comments_count: 128,
          bronze_badges: 124,
          gold_badges: 38,
          platinum_badges: 12
        }
      };
      
      // Load mock data
      displayProfile();
      await loadUserArticles();
      await loadUserLibraries();
      await loadUserComments();
      
      hideLoadingState();
    } else {
      // Fetch real user from database
      const { data: userData, error: userError } = await supabase
        .from('users')
        .select(`
          *,
          user_stats!inner(*)
        `)
        .eq('id', userId)
        .eq('is_active', true)
        .single();
      
      if (userError) throw userError;
      if (!userData) throw new Error('User not found');
      
      currentUser = userData;
      
      displayProfile();
      await loadUserArticles();
      await loadUserLibraries();
      await loadUserComments();
      
      hideLoadingState();
    }
    
  } catch (error) {
    console.error('Error loading profile:', error);
    showErrorState();
  }
}

function displayProfile() {
  if (!currentUser) return;
  
  document.getElementById('profileName').textContent = currentUser.display_name || currentUser.full_name;
  document.getElementById('profilePhoto').src = currentUser.profile_photo_url || 'https://via.placeholder.com/200';
  document.getElementById('bioText').textContent = currentUser.bio || 'No biography available.';
  document.getElementById('emailText').textContent = currentUser.email || 'No contact information available.';
  
  // Update stats
  const stats = currentUser.user_stats || {};
  document.getElementById('followersCount').textContent = formatNumber(stats.followers_count || 0);
  document.getElementById('followingCount').textContent = formatNumber(stats.following_count || 0);
  document.getElementById('bronzeBadges').textContent = stats.bronze_badges || 0;
  document.getElementById('goldBadges').textContent = stats.gold_badges || 0;
  document.getElementById('platinumBadges').textContent = stats.platinum_badges || 0;
  
  // Update tab counts
  document.getElementById('articlesCount').textContent = `(${stats.articles_count || 0})`;
  document.getElementById('commentsCount').textContent = `(${stats.comments_count || 0})`;
}

async function loadUserArticles() {
  try {
    let articles = [];
    
    if (currentUserId === 'test-user') {
      // Mock articles for demonstration
      articles = [
        {
          id: '1',
          title: 'Understanding Cardiovascular Pathology: A Comprehensive Review',
          published_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
          read_time_minutes: 12,
          article_stats: { views_count: 3200 }
        },
        {
          id: '2',
          title: 'Advanced Diagnostic Techniques in Cardiac Imaging',
          published_at: new Date(Date.now() - 22 * 24 * 60 * 60 * 1000).toISOString(),
          read_time_minutes: 15,
          article_stats: { views_count: 2800 }
        },
        {
          id: '3',
          title: 'Molecular Pathology in Heart Disease Research',
          published_at: new Date(Date.now() - 32 * 24 * 60 * 60 * 1000).toISOString(),
          read_time_minutes: 18,
          article_stats: { views_count: 4100 }
        }
      ];
    } else {
      // Fetch real articles from database
      const { data, error } = await supabase
        .from('articles')
        .select(`
          *,
          article_stats!inner(views_count)
        `)
        .eq('author_id', currentUserId)
        .eq('status', 'published')
        .order('published_at', { ascending: false })
        .limit(10);
      
      if (error) throw error;
      articles = data || [];
    }
    
    displayArticles(articles);
    
  } catch (error) {
    console.error('Error loading user articles:', error);
  }
}

async function loadUserLibraries() {
  try {
    let libraries = [];
    
    if (currentUserId === 'test-user') {
      // Mock libraries for demonstration
      libraries = [
        {
          id: '1',
          name: 'Cardiovascular Research Collection',
          updated_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
          article_count: 24
        },
        {
          id: '2',
          name: 'Medical Student Resources',
          updated_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
          article_count: 18
        },
        {
          id: '3',
          name: 'Diagnostic Imaging Techniques',
          updated_at: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
          article_count: 15
        }
      ];
    } else {
      // Fetch real libraries from database
      const { data, error } = await supabase
        .from('libraries')
        .select(`
          *,
          library_items!inner(count)
        `)
        .eq('creator_id', currentUserId)
        .order('updated_at', { ascending: false });
      
      if (error) throw error;
      libraries = data || [];
    }
    
    displayLibraries(libraries);
    
  } catch (error) {
    console.error('Error loading user libraries:', error);
  }
}

async function loadUserComments() {
  try {
    let comments = [];
    
    if (currentUserId === 'test-user') {
      // Mock comments for demonstration
      comments = [
        {
          id: '1',
          article_title: 'Understanding Cardiovascular Pathology',
          content: 'Excellent point about imaging technology. The development of cardiac MRI has been particularly transformative in our field.',
          created_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
          id: '2',
          article_title: 'Molecular Mechanisms of Cancer Progression',
          content: 'This multi-factorial approach is crucial. Have you considered exploring the role of genetic predisposition in greater detail?',
          created_at: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
          id: '3',
          article_title: 'Clinical Applications of Immunotherapy',
          content: 'The inflammatory biomarkers you mention are indeed valuable. We have been using them extensively in our clinical practice.',
          created_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString()
        }
      ];
    } else {
      // Fetch real comments from database
      const { data, error } = await supabase
        .from('comments')
        .select(`
          *,
          articles!inner(title)
        `)
        .eq('user_id', currentUserId)
        .order('created_at', { ascending: false })
        .limit(20);
      
      if (error) throw error;
      comments = data || [];
    }
    
    displayComments(comments);
    
  } catch (error) {
    console.error('Error loading user comments:', error);
  }
}

function displayArticles(articles) {
  const articlesList = document.getElementById('articlesList');
  
  if (articles.length === 0) {
    articlesList.innerHTML = '<div class="error-state"><p>No articles found.</p></div>';
    return;
  }
  
  articlesList.innerHTML = articles.map((article, index) => {
    const publishedDate = new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    const readTime = article.read_time_minutes || 10;
    const views = article.article_stats?.views_count || 0;
    
    return `
      <li class="article-item" onclick="openArticle('${article.id}')" style="animation-delay: ${index * 0.05}s">
        <h2 class="article-title">${escapeHtml(article.title)}</h2>
        <div class="article-meta">
          <span>${publishedDate}</span>
          <div class="meta-dot"></div>
          <span>${readTime} min read</span>
          <div class="meta-dot"></div>
          <span>${formatNumber(views)} views</span>
        </div>
      </li>
    `;
  }).join('');
}

function displayLibraries(libraries) {
  const librariesList = document.getElementById('librariesList');
  
  if (libraries.length === 0) {
    librariesList.innerHTML = '<div class="error-state"><p>No libraries found.</p></div>';
    return;
  }
  
  librariesList.innerHTML = libraries.map((library, index) => {
    const updatedDate = new Date(library.updated_at || library.created_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    const articleCount = library.article_count || library.library_items?.[0]?.count || 0;
    
    return `
      <li class="library-item" onclick="openLibrary('${library.id}')" style="animation-delay: ${index * 0.05}s">
        <h3 class="library-title">${escapeHtml(library.name)}</h3>
        <div class="library-meta">${articleCount} articles • Updated ${updatedDate}</div>
      </li>
    `;
  }).join('');
  
  // Update libraries count
  document.getElementById('librariesCount').textContent = `(${libraries.length})`;
}

function displayComments(comments) {
  const commentsList = document.getElementById('commentsList');
  
  if (comments.length === 0) {
    commentsList.innerHTML = '<div class="error-state"><p>No comments found.</p></div>';
    return;
  }
  
  commentsList.innerHTML = comments.map((comment, index) => {
    const articleTitle = comment.articles?.title || comment.article_title || 'Unknown Article';
    const commentDate = new Date(comment.created_at).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    
    return `
      <div class="comment-item" style="animation-delay: ${index * 0.05}s">
        <div class="comment-article">On "${escapeHtml(articleTitle)}"</div>
        <div class="comment-text">${escapeHtml(comment.content || comment.text)}</div>
        <div class="comment-meta">${commentDate}</div>
      </div>
    `;
  }).join('');
}

// Tab switching
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  event.target.classList.add('active');
  document.getElementById(tabName + '-tab').classList.add('active');
}

// Utility functions
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

function openArticle(articleId) {
  window.location.href = `Articls.html?id=${articleId}`;
}

function openLibrary(libraryId) {
  // In a real app, this would navigate to a library page
  alert('Navigate to library: ' + libraryId);
}

function goHome() {
  window.location.href = 'Lists.html';
}

// State management functions
function showLoadingState() {
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('errorState').style.display = 'none';
  document.getElementById('profileContent').style.display = 'none';
}

function hideLoadingState() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('profileContent').style.display = 'block';
}

function showErrorState() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('profileContent').style.display = 'none';
}
</script>

</body>
</html>
