<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes">
    <title>Article Scroller - Patholytica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Your existing CSS remains the same] */
    </style>
</head>
<body>
    <div class="app-container">
        <div class="scroller-container">
            <div class="posts-wrapper" id="postsWrapper">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <div>Loading articles...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="comments-overlay" id="commentsOverlay" onclick="closeComments()"></div>
    
    <div class="comments-panel" id="commentsPanel">
        <div class="comments-header">
            <h3>Comments</h3>
            <button class="close-comments" onclick="closeComments()">Ã—</button>
        </div>
        <div class="comments-list" id="commentsList">
            <div class="no-comments">
                <i class="fas fa-comments"></i>
                <div>No comments yet</div>
                <div style="font-size: 12px;">Be the first to comment!</div>
            </div>
        </div>
        <div class="comment-input-wrapper">
            <div class="comment-input-container">
                <input type="text" class="comment-input" id="commentInput" placeholder="Add a comment...">
                <button class="send-comment-btn" id="sendCommentBtn" onclick="sendComment()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="footer-bar">
        <button class="footer-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="footer-btn active">
            <i class="fas fa-scroll"></i>
            <span>Feed</span>
        </button>
        <button class="footer-btn" onclick="window.location.href='explore.html'">
            <i class="fas fa-search"></i>
            <span>Explore</span>
        </button>
        <button class="footer-btn" onclick="window.location.href='profile.html'">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
            authDomain: "patholytica.firebaseapp.com",
            databaseURL: "https://patholytica-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "patholytica",
            storageBucket: "patholytica.firebasestorage.app",
            messagingSenderId: "738430635282",
            appId: "1:738430635282:web:8451ef380447c7611137cb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const supabase = window.supabase.createClient(
            "https://vduqewqyvszfquntmark.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdXFld3F5dnN6ZnF1bnRtYXJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzcyMTc1NDUsImV4cCI6MjA1Mjc5MzU0NX0.a-VNRQBb0YkSWp0e7r9R1WdFNnCDZ8VqxV2EkSdPqEE"
        );

        let articles = [];
        let liked = {};
        let currentArticleId = null;
        let currentIndex = 0;
        let isLoading = false;
        let hasMore = true;
        let offset = 0;
        const LIMIT = 10;
        let currentUser = null;
        let authInitialized = false;

        // Wait for auth to initialize before doing anything
        async function waitForAuth() {
            return new Promise((resolve) => {
                if (authInitialized) {
                    resolve();
                    return;
                }
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    authInitialized = true;
                    if (user) {
                        currentUser = await getCurrentUser();
                    }
                    unsubscribe();
                    resolve();
                });
            });
        }

        async function getCurrentUser() {
            try {
                const firebaseUser = auth.currentUser;
                if (!firebaseUser) {
                    console.log('No Firebase user logged in');
                    return null;
                }
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('user_id, firebase_uid, username, full_name')
                    .eq('firebase_uid', firebaseUser.uid)
                    .single();
                
                if (error) {
                    console.error('Error fetching user from Supabase:', error);
                    return null;
                }
                
                return userData;
            } catch (error) {
                console.error('Error getting current user:', error);
                return null;
            }
        }

        async function loadArticles(isInitial = true) {
            if (isLoading || (!isInitial && !hasMore)) return;
            
            isLoading = true;

            try {
                const { data: articlesData, error: articlesError } = await supabase
                    .from('articles')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range(offset, offset + LIMIT - 1);

                if (articlesError) throw articlesError;

                if (!articlesData || articlesData.length === 0) {
                    if (isInitial) {
                        document.getElementById('postsWrapper').innerHTML = `
                            <div class="loading-container">
                                <i class="fas fa-inbox" style="font-size: 48px;"></i>
                                <div>No articles found</div>
                            </div>
                        `;
                    }
                    hasMore = false;
                    isLoading = false;
                    return;
                }

                if (articlesData.length < LIMIT) {
                    hasMore = false;
                }

                offset += articlesData.length;

                const userIds = [...new Set(articlesData.map(a => a.firebase_user_id).filter(id => id))];
                
                let usersData = [];
                if (userIds.length > 0) {
                    const { data: users } = await supabase
                        .from('users')
                        .select('firebase_uid, username, full_name')
                        .in('firebase_uid', userIds);
                    
                    usersData = users || [];
                }

                const articleIds = articlesData.map(a => a.id);
                const { data: mediaData } = await supabase
                    .from('media')
                    .select('*')
                    .in('article_id', articleIds)
                    .order('display_order', { ascending: true });

                const newArticles = articlesData.map(article => {
                    const user = usersData?.find(u => u.firebase_uid === article.firebase_user_id);
                    const articleMedia = mediaData?.filter(m => m.article_id === article.id) || [];
                    
                    return {
                        ...article,
                        author: user?.username ? `@${user.username}` : (user?.full_name || 'Anonymous'),
                        media: articleMedia
                    };
                });

                articles = [...articles, ...newArticles];
                renderArticles(isInitial);
                isLoading = false;

            } catch (error) {
                console.error('Error loading articles:', error);
                if (isInitial) {
                    document.getElementById('postsWrapper').innerHTML = `
                        <div class="loading-container">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                            <div>Failed to load articles</div>
                        </div>
                    `;
                }
                isLoading = false;
            }
        }

        function createMediaElement(mediaItem) {
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'media-embed';

            if (mediaItem.type === 'image') {
                mediaDiv.innerHTML = `
                    <img src="${mediaItem.url}" alt="${mediaItem.caption || 'Article image'}" loading="lazy">
                    ${mediaItem.caption ? `<div class="media-caption">${escapeHtml(mediaItem.caption)}</div>` : ''}
                `;
            } else if (mediaItem.type === 'audio') {
                const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
                mediaDiv.innerHTML = `
                    <div class="custom-audio-player">
                        <button class="play-btn" onclick="window.toggleAudio(this, '${audioId}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="audio-info">
                            <div class="audio-title">${escapeHtml(mediaItem.caption || 'Audio')}</div>
                            <div class="waveform-container" onclick="window.seekAudio(event, this, '${audioId}')">
                                <div class="waveform-progress"></div>
                                <div class="waveform-bars">
                                    ${Array(15).fill(0).map(() => `<div class="waveform-bar" style="height: ${Math.random() * 60 + 20}%"></div>`).join('')}
                                </div>
                            </div>
                            <div class="audio-time">
                                <span class="current-time">0:00</span>
                                <span class="duration">0:00</span>
                            </div>
                        </div>
                        <audio id="${audioId}" src="${mediaItem.url}" preload="metadata"></audio>
                    </div>
                `;

                setTimeout(() => {
                    const audio = document.getElementById(audioId);
                    if (audio) {
                        audio.addEventListener('loadedmetadata', function() {
                            const duration = Math.floor(audio.duration);
                            const mins = Math.floor(duration / 60);
                            const secs = duration % 60;
                            const durationSpan = audio.closest('.custom-audio-player')?.querySelector('.duration');
                            if (durationSpan) {
                                durationSpan.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                            }
                        });
                    }
                }, 100);
            }

            return mediaDiv;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderArticles(isInitial = true) {
            const wrapper = document.getElementById('postsWrapper');
            
            if (isInitial) {
                wrapper.innerHTML = '';
            } else {
                const loadingMore = wrapper.querySelector('.loading-more');
                if (loadingMore) {
                    loadingMore.remove();
                }
            }

            const startIndex = isInitial ? 0 : articles.length - LIMIT;
            const endIndex = articles.length;

            for (let index = startIndex; index < endIndex; index++) {
                const article = articles[index];
                const articleDiv = document.createElement('div');
                articleDiv.className = 'article-card';
                articleDiv.dataset.index = index;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'article-content';
                
                const paragraphs = (article.content || 'No content available').split('\n\n');
                paragraphs.forEach((paragraph, pIndex) => {
                    if (paragraph.trim()) {
                        const p = document.createElement('div');
                        p.className = 'content-paragraph';
                        p.textContent = paragraph.trim();
                        contentDiv.appendChild(p);

                        if (article.media && article.media.length > 0) {
                            const relatedMedia = article.media.filter(m => m.display_order === pIndex);
                            relatedMedia.forEach(m => {
                                contentDiv.appendChild(createMediaElement(m));
                            });
                        }
                    }
                });

                if (article.media) {
                    article.media.filter(m => m.display_order >= paragraphs.length).forEach(m => {
                        contentDiv.appendChild(createMediaElement(m));
                    });
                }

                articleDiv.innerHTML = `
                    <div class="article-header">
                        <div class="author-avatar">${escapeHtml(article.author.charAt(0).toUpperCase())}</div>
                        <div class="author-info">
                            <div class="author-name">${escapeHtml(article.author)}</div>
                            <div class="article-date">${formatDate(new Date(article.created_at))}</div>
                        </div>
                    </div>
                    
                    <div class="article-title">${escapeHtml(article.title || 'Untitled')}</div>
                    
                    <div class="action-buttons">
                        <button class="action-btn like-btn ${liked[article.id] ? 'liked' : ''}" data-id="${article.id}">
                            <svg viewBox="0 0 24 24">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            <span class="like-count">${article.likes || 0}</span>
                        </button>
                        
                        <button class="action-btn comment-btn" data-id="${article.id}">
                            <svg viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span class="comment-count">0</span>
                        </button>

                        <button class="action-btn expand-btn" data-id="${article.id}">
                            <svg viewBox="0 0 24 24">
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <polyline points="9 21 3 21 3 15"></polyline>
                                <line x1="21" y1="3" x2="14" y2="10"></line>
                                <line x1="3" y1="21" x2="10" y2="14"></line>
                            </svg>
                            <span>Open</span>
                        </button>
                    </div>
                `;
                
                articleDiv.querySelector('.article-title').insertAdjacentElement('afterend', contentDiv);
                wrapper.appendChild(articleDiv);
            }

            if (hasMore) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'article-card loading-more';
                loadingDiv.innerHTML = `
                    <div class="spinner"></div>
                    <span>Loading more...</span>
                `;
                wrapper.appendChild(loadingDiv);
            }

            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', handleLike);
            });

            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', handleComments);
            });

            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', handleExpand);
            });

            if (isInitial) {
                wrapper.addEventListener('scroll', handleScroll);
                loadCommentCounts();
            }
        }

        async function loadCommentCounts() {
            try {
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('article_id');

                if (error) throw error;

                const counts = {};
                comments.forEach(comment => {
                    counts[comment.article_id] = (counts[comment.article_id] || 0) + 1;
                });

                document.querySelectorAll('.comment-btn').forEach(btn => {
                    const articleId = btn.dataset.id;
                    const countSpan = btn.querySelector('.comment-count');
                    countSpan.textContent = counts[articleId] || 0;
                });
            } catch (error) {
                console.error('Error loading comment counts:', error);
            }
        }

        function formatDate(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        async function handleLike(e) {
            const articleId = e.currentTarget.dataset.id;
            const btn = e.currentTarget;
            const countSpan = btn.querySelector('.like-count');
            const article = articles.find(a => a.id === articleId);
            
            if (!article) return;

            const wasLiked = liked[articleId];
            const originalCount = article.likes || 0;

            if (wasLiked) {
                liked[articleId] = false;
                btn.classList.remove('liked');
                article.likes = Math.max(0, originalCount - 1);
            } else {
                liked[articleId] = true;
                btn.classList.add('liked');
                article.likes = originalCount + 1;
            }
            
            countSpan.textContent = article.likes;

            try {
                await supabase
                    .from('articles')
                    .update({ likes: article.likes })
                    .eq('id', articleId);
            } catch (error) {
                console.error('Error updating like:', error);
                // Revert on error
                liked[articleId] = wasLiked;
                article.likes = originalCount;
                countSpan.textContent = article.likes;
                if (wasLiked) {
                    btn.classList.add('liked');
                } else {
                    btn.classList.remove('liked');
                }
            }
        }

        async function handleComments(e) {
            const articleId = e.currentTarget.dataset.id;
            currentArticleId = articleId;
            await loadComments(articleId);
            openComments();
        }

        async function loadComments(articleId) {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '<div class="loading-container"><div class="spinner" style="width: 32px; height: 32px; border-width: 3px;"></div></div>';

            try {
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('*')
                    .eq('article_id', articleId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (!comments || comments.length === 0) {
                    commentsList.innerHTML = `
                        <div class="no-comments">
                            <i class="fas fa-comments"></i>
                            <div>No comments yet</div>
                            <div style="font-size: 12px;">Be the first to comment!</div>
                        </div>
                    `;
                    return;
                }

                const userIds = [...new Set(comments.map(c => c.user_id).filter(id => id))];
                let usersMap = {};
                
                if (userIds.length > 0) {
                    const { data: users } = await supabase
                        .from('users')
                        .select('user_id, username, full_name')
                        .in('user_id', userIds);
                    
                    if (users) {
                        users.forEach(user => {
                            usersMap[user.user_id] = user;
                        });
                    }
                }

                commentsList.innerHTML = comments.map(comment => {
                    const user = usersMap[comment.user_id];
                    const author = user?.username ? `@${user.username}` : (user?.full_name || 'Anonymous');
                    
                    return `
                        <div class="comment-item">
                            <div class="comment-avatar">${escapeHtml(author.charAt(0).toUpperCase())}</div>
                            <div class="comment-content">
                                <div class="comment-author">${escapeHtml(author)}</div>
                                <div class="comment-text">${escapeHtml(comment.comment_text)}</div>
                                <div class="comment-time">${formatDate(new Date(comment.created_at))}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading comments:', error);
                commentsList.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>Failed to load comments</div>
                    </div>
                `;
            }
        }

        window.openComments = function() {
            document.getElementById('commentsPanel').classList.add('active');
            document.getElementById('commentsOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        window.closeComments = function() {
            document.getElementById('commentsPanel').classList.remove('active');
            document.getElementById('commentsOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        window.sendComment = async function() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (!text || !currentArticleId) {
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                currentUser = await getCurrentUser();
            }

            if (!currentUser) {
                alert('Please log in to comment');
                window.location.href = 'login.html';
                return;
            }

            const sendBtn = document.getElementById('sendCommentBtn');
            const originalText = text;
            sendBtn.disabled = true;
            input.value = '';

            try {
                const { data, error } = await supabase
                    .from('comments')
                    .insert([{
                        article_id: currentArticleId,
                        user_id: currentUser.user_id,
                        comment_text: originalText
                    }])
                    .select();

                if (error) throw error;

                await loadComments(currentArticleId);
                
                const commentBtn = document.querySelector(`.comment-btn[data-id="${currentArticleId}"]`);
                if (commentBtn) {
                    const countSpan = commentBtn.querySelector('.comment-count');
                    countSpan.textContent = parseInt(countSpan.textContent) + 1;
                }

            } catch (error) {
                console.error('Error posting comment:', error);
                input.value = originalText;
                alert('Failed to post comment. Please try again.');
            } finally {
                sendBtn.disabled = false;
            }
        }

        document.getElementById('commentInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.sendComment();
            }
        });

        function handleExpand(e) {
            const articleId = e.currentTarget.dataset.id;
            window.location.href = `article.html?id=${articleId}`;
        }

        function handleScroll(e) {
            const container = e.target;
            const scrollPosition = container.scrollTop;
            const scrollHeight = container.scrollHeight;
            const clientHeight = container.clientHeight;

            if (scrollPosition + clientHeight >= scrollHeight * 0.8 && hasMore && !isLoading) {
                loadArticles(false);
            }
        }

        // Initialize app
        (async function init() {
            await waitForAuth();
            await loadArticles(true);
        })();

    </script>

    <script>
        window.toggleAudio = function(btn, audioId) {
            const player = btn.closest('.custom-audio-player');
            const audio = document.getElementById(audioId);
            if (!audio || !player) return;
            
            const icon = btn.querySelector('i');
            
            // Pause all other audio elements
            document.querySelectorAll('audio').forEach(a => {
                if (a.id !== audioId && !a.paused) {
                    a.pause();
                    const otherBtn = document.querySelector(`button[onclick*="${a.id}"]`);
                    if (otherBtn) {
                        otherBtn.querySelector('i').className = 'fas fa-play';
                    }
                }
            });
            
            if (audio.paused) {
                audio.play();
                icon.className = 'fas fa-pause';
                
                audio.ontimeupdate = function() {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    const progressBar = player.querySelector('.waveform-progress');
                    const currentTimeSpan = player.querySelector('.current-time');
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                    if (currentTimeSpan) {
                        const currentMins = Math.floor(audio.currentTime / 60);
                        const currentSecs = Math.floor(audio.currentTime % 60);
                        currentTimeSpan.textContent = `${currentMins}:${currentSecs.toString().padStart(2, '0')}`;
                    }
                };
                
                audio.onended = function() {
                    icon.className = 'fas fa-play';
                    const progressBar = player.querySelector('.waveform-progress');
                    const currentTimeSpan = player.querySelector('.current-time');
                    if (progressBar) progressBar.style.width = '0%';
                    if (currentTimeSpan) currentTimeSpan.textContent = '0:00';
                };
            } else {
                audio.pause();
                icon.className = 'fas fa-play';
            }
        };

        window.seekAudio = function(event, container, audioId) {
            const audio = document.getElementById(audioId);
            if (!audio || !audio.duration) return;
            
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = Math.max(0, Math.min(1, x / rect.width));
            audio.currentTime = percentage * audio.duration;
        };
    </script>
</body>
</html>