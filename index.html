<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Patholytica — by MedicineBank</title>
<style>
:root {
  --bg-color: #0d0d0d;
  --text-color: #fff;
  --card-bg: rgba(24,24,24,0.7);
  --card-border: rgba(255,255,255,0.07);
  --accent: #b0003a;
  --accent-hover: #88002a;
}
body.light-theme {
  --bg-color: #f5f5f5;
  --text-color: #111;
  --card-bg: rgba(255,255,255,0.65);
  --card-border: rgba(0,0,0,0.1);
  --accent: #b0003a;
  --accent-hover: #88002a;
}
* { box-sizing: border-box; }
html, body { margin:0; padding:0; height:100%; font-family: "Inter", Arial, sans-serif; }
body {
  background: var(--bg-color);
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  transition: background 0.35s ease;
}
.header-wrapper {
  position: sticky;
  top: 0;
  background: var(--bg-color);
  padding-top: env(safe-area-inset-top);
  border-bottom: 1px solid var(--card-border);
  z-index: 40;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
}
.logo-img { height: 32px; width: auto; transition: filter 0.25s ease; cursor: pointer; }
body.light-theme .logo-img { filter: invert(1); }
.theme-toggle {
  padding: 6px 14px;
  font-size: 12.5px;
  background: transparent;
  border-radius: 6px;
  border: 1px solid var(--card-border);
  color: var(--text-color);
  cursor: pointer;
  transition: 0.25s ease;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }
.login-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: calc(40px + env(safe-area-inset-top))
           calc(20px + env(safe-area-inset-left))
           calc(40px + env(safe-area-inset-bottom))
           calc(20px + env(safe-area-inset-right));
}
.login-card {
  width: 100%;
  max-width: 430px;
  padding: 55px 42px;
  background: var(--card-bg);
  backdrop-filter: blur(22px);
  border-radius: 16px;
  border: 1px solid var(--card-border);
  box-shadow: 0 8px 28px rgba(0,0,0,0.45);
  text-align: center;
  animation: fadeUp 0.5s ease both;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.login-card:hover { transform: translateY(-4px); box-shadow: 0 12px 35px rgba(0,0,0,0.55); }
.login-card h1 { font-size: 32px; margin-bottom: 12px; }
.login-card p { font-size: 15px; margin-bottom: 20px; color: #999; line-height: 1.55; }
.login-btn {
  display: inline-block;
  padding: 16px 42px;
  font-size: 16px;
  font-weight: 600;
  background: var(--accent);
  color: #fff;
  border-radius: 10px;
  text-decoration: none;
  transition: 0.25s ease;
  box-shadow: 0 6px 16px rgba(176,0,58,0.35);
  cursor: pointer;
  border: none;
  margin-bottom: 12px;
  width: 100%;
}
.login-btn:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 10px 22px rgba(176,0,58,0.45); }
.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}
.google-btn {
  background: #4285F4;
  box-shadow: 0 6px 16px rgba(66,133,244,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}
.google-btn:hover { background: #357ae8; box-shadow: 0 10px 22px rgba(66,133,244,0.45); }
.google-icon { width: 20px; height: 20px; background: white; border-radius: 2px; padding: 2px; display: inline-block; }
.google-icon svg { display: block; width: 100%; height: 100%; }
.divider { display: flex; align-items: center; margin: 20px 0; color: #666; font-size: 13px; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--card-border); }
.divider::before { margin-right: 12px; }
.divider::after { margin-left: 12px; }
.guest-text { display: block; font-size: 14px; color: var(--accent); margin-top: 6px; cursor: pointer; font-weight: 600; text-decoration: none; }
.guest-text:hover { text-decoration: underline; }
.input-field {
  width: 100%;
  padding: 14px;
  margin-bottom: 14px;
  border-radius: 8px;
  border: 1px solid var(--card-border);
  background: rgba(0,0,0,0.25);
  color: var(--text-color);
  font-size: 15px;
  transition: 0.25s ease;
}
body.light-theme .input-field { background: rgba(255,255,255,0.7); }
.input-field:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 8px rgba(176,0,58,0.35); }
#loginForm, #signupForm { transition: opacity 0.25s ease; }
footer { text-align: center; padding: 16px; font-size: 11px; border-top: 1px solid var(--card-border); color: #888; }
footer a { color: #888; margin: 0 3px; text-decoration: none; transition: color 0.25s ease; }
footer a:hover { color: var(--accent); }
@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@media (max-width: 640px) { .login-card { padding: 45px 30px; } .login-card h1 { font-size: 27px; } }
</style>
</head>
<body>

<div class="header-wrapper">
  <div class="header">
    <a href="https://patholytica.com"><img src="IMG_0696.png" class="logo-img" alt="Patholytica Logo"></a>
    <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
  </div>
</div>

<div class="login-container">
  <div class="login-card">
    <h1>Welcome to Patholytica</h1>
    <p>Your tool to <strong>LOVE</strong> what you learn</p>

<div id="initialButtons">
  <button id="googleLoginBtn" class="login-btn google-btn">Continue with Google</button>
  <div class="divider">OR</div>
  <button class="login-btn" id="startLoginBtn">Login with Email</button>
  <span class="guest-text" id="guestBtn">Guest Mode</span>
</div>

<form id="loginForm" style="display:none; margin-top:20px; animation: fadeUp 0.5s ease both;">
  <input type="email" placeholder="Email Address" class="input-field" required>
  <input type="password" placeholder="Password" class="input-field" required>
  <button type="submit" class="login-btn" style="width:100%; margin-top:12px;">Continue</button>
  <p style="margin-top:20px; font-size:14px; color:#999;">
    Don't have an account? 
    <a href="#" id="showSignupLink" style="color:var(--accent); text-decoration:none; font-weight:600;">Sign up</a>
  </p>
  <p style="margin-top:10px; font-size:14px;">
    <a href="#" id="backToInitial" style="color:#888; text-decoration:none;">← Back</a>
  </p>
</form>

<form id="signupForm" style="display:none; margin-top:20px; animation: fadeUp 0.5s ease both;">
  <input type="text" placeholder="Full Name" class="input-field" required>
  <input type="email" placeholder="Email Address" class="input-field" required>
  <input type="text" placeholder="Username" class="input-field" required>
  <input type="password" placeholder="Password (min. 8 characters)" class="input-field" minlength="8" required>
  <input type="password" placeholder="Confirm Password" class="input-field" required>
  <label style="display:flex; align-items:center; justify-content:center; margin:16px 0; font-size:13px; color:#999;">
    <input type="checkbox" required style="margin-right:8px;">
    I agree to the <a href="#" style="color:var(--accent); margin:0 3px;">Terms</a> 
    and <a href="#" style="color:var(--accent); margin:0 3px;">Privacy Policy</a>
  </label>
  <button type="submit" class="login-btn" style="width:100%; margin-top:12px;">Create Account</button>
  <p style="margin-top:20px; font-size:14px; color:#999;">
    Already have an account?
    <a href="#" id="showLoginLink" style="color:var(--accent); font-weight:600;">Login</a>
  </p>
</form>

  </div>
</div>

<footer>
  © 2025 Patholytica by MedicineBank. All rights reserved.
  <br>
  <a href="#">Privacy Policy</a> | <a href="#">Terms</a> | <a href="#">Contact</a>
</footer>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyBs6V0yY14cuLBXB1nciZ-X0eyAiodC-Ak",
  authDomain: "patholytica.firebaseapp.com",
  projectId: "patholytica",
  storageBucket: "patholytica.firebasestorage.app",
  messagingSenderId: "738430635282",
  appId: "1:738430635282:web:8451ef380447c7611137cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// THEME
function toggleTheme(){
  document.body.classList.toggle('light-theme');
  localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
}
if (localStorage.getItem("theme") === "light") { document.body.classList.add("light-theme"); }
window.toggleTheme = toggleTheme;

// UI elements
const initialButtons = document.getElementById("initialButtons");
const startBtn = document.getElementById("startLoginBtn");
const form = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const showSignupLink = document.getElementById("showSignupLink");
const showLoginLink = document.getElementById("showLoginLink");
const guestBtn = document.getElementById("guestBtn");
const backToInitial = document.getElementById("backToInitial");

// Form toggles
startBtn.addEventListener("click", () => { initialButtons.style.opacity="0"; setTimeout(()=>{ initialButtons.style.display="none"; form.style.display="block"; form.style.opacity="1"; }, 250); });
backToInitial.addEventListener("click",(e)=>{ e.preventDefault(); form.style.opacity="0"; setTimeout(()=>{ form.style.display="none"; initialButtons.style.display="block"; initialButtons.style.opacity="1"; },250); });
guestBtn.addEventListener("click",()=>{ alert("Entering Guest Mode. Limited features available."); });
showSignupLink.addEventListener("click",(e)=>{ e.preventDefault(); form.style.opacity="0"; setTimeout(()=>{ form.style.display="none"; signupForm.style.display="block"; signupForm.style.opacity="1"; },250); });
showLoginLink.addEventListener("click",(e)=>{ e.preventDefault(); signupForm.style.opacity="0"; setTimeout(()=>{ signupForm.style.display="none"; form.style.display="block"; form.style.opacity="1"; },250); });

// LOGIN
form.addEventListener("submit", async (e)=> {
  e.preventDefault();
  const inputs = form.querySelectorAll("input");
  const email = inputs[0].value;
  const password = inputs[1].value;
  try {
    const userCredential = await signInWithEmailAndPassword(auth,email,password);
    const user = userCredential.user;
    const docRef = doc(db,"users",user.uid);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()){
      await setDoc(docRef,{email:user.email, createdAt:new Date()});
    }
    window.location.href="dashboard.html";
  } catch(err){ alert("Login failed: "+err.message); console.error(err); }
});

// SIGNUP
signupForm.addEventListener("submit", async (e)=> {
  e.preventDefault();
  const inputs = signupForm.querySelectorAll("input");
  const fullName = inputs[0].value;
  const email = inputs[1].value;
  const username = inputs[2].value;
  const password = inputs[3].value;
  const confirmPassword = inputs[4].value;

  if(password !== confirmPassword){ alert("Passwords do not match."); return; }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const user = userCredential.user;
    await setDoc(doc(db,"users",user.uid),{
      fullName: fullName,
      email: email,
      username: username,
      createdAt: new Date(),
      bio:"",
      profilePicture:"",
      settings:{theme:"dark"}
    });
    window.location.href="dashboard.html";
  } catch(err){ alert("Signup failed: "+err.message); console.error(err); }
});

// GOOGLE SIGN-IN (FIXED)
const provider = new GoogleAuthProvider();
let isGoogleSignInInProgress = false;

document.getElementById("googleLoginBtn").addEventListener("click", async ()=>{
  // Prevent multiple simultaneous sign-in attempts
  if(isGoogleSignInInProgress) return;
  
  isGoogleSignInInProgress = true;
  const btn = document.getElementById("googleLoginBtn");
  const originalText = btn.innerHTML;
  btn.innerHTML = "Signing in...";
  btn.disabled = true;
  
  try {
    const result = await signInWithPopup(auth,provider);
    const user = result.user;
    const docRef = doc(db,"users",user.uid);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()){
      await setDoc(docRef,{
        fullName:user.displayName||"",
        email:user.email,
        createdAt:new Date(),
        bio:"",
        profilePicture:user.photoURL||"",
        settings:{theme:"dark"},
        provider:"google"
      });
    }
    window.location.href="dashboard.html";
  } catch(err){ 
    // Only show error if it's not a user-cancelled action
    if(err.code !== 'auth/popup-closed-by-user' && err.code !== 'auth/cancelled-popup-request'){
      alert("Google sign-in failed: "+err.message);
    }
    console.error(err);
    btn.innerHTML = originalText;
    btn.disabled = false;
    isGoogleSignInInProgress = false;
  }
});
</script>

</body>
</html>